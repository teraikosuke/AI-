# æ­©ç•™ã¾ã‚Šç®¡ç†ç”»é¢ å®Œå…¨æŠ€è¡“ä»•æ§˜æ›¸

## ğŸ“Š æ¦‚è¦

æ­©ç•™ã¾ã‚Šç®¡ç†ç”»é¢ã¯ã€æ¡ç”¨æ´»å‹•ã®KPIï¼ˆKey Performance Indicatorsï¼‰ã‚’å¯è¦–åŒ–ãƒ»åˆ†æã™ã‚‹ãŸã‚ã®æœ€é‡è¦ç”»é¢ã§ã™ã€‚

**ä¸»è¦æ©Ÿèƒ½**:
- å€‹äººKPIè¡¨ç¤ºï¼ˆè‡ªåˆ†ã®å®Ÿç¸¾ï¼‰
- å…¨ç¤¾KPIè¡¨ç¤ºï¼ˆä¼šç¤¾å…¨ä½“ã®å®Ÿç¸¾ï¼‰
- æ—¥åˆ¥å®Ÿç¸¾è©³ç´°
- ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•
- MSï¼ˆManagement Summaryï¼‰ãƒ¬ãƒãƒ¼ãƒˆ
- éƒ¨é–€åˆ¥åˆ†æï¼ˆMarketing, CS, Salesï¼‰

---

## 1. ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«

### 1.1 ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«

#### [candidates](file:///Users/riho/Documents/GitHub/AI-/pages/candidates/candidates.js#12-13) ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå€™è£œè€…åŸºæœ¬æƒ…å ±ï¼‰

**KPIè¨ˆç®—ã§ä½¿ç”¨ã™ã‚‹ã‚«ãƒ©ãƒ **:

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | ç”¨é€” | KPIè¨ˆç®—ã§ã®å½¹å‰² |
|---------|---------|------|----------------|
| id | bigint | å€™è£œè€…ID | JOINç”¨ |
| advisor_user_id | bigint | æ‹…å½“ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ID | **å€‹äººKPIã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°** |
| created_at | timestamptz | ä½œæˆæ—¥æ™‚ | **å¿œå‹Ÿæ—¥æ™‚ã®åˆ¤å®š** |
| first_contact_at | timestamptz | åˆå›æ¥è§¦æ—¥æ™‚ | **æ–°è¦é¢è«‡æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |
| is_effective_application | boolean | æœ‰åŠ¹å¿œå‹Ÿãƒ•ãƒ©ã‚° | **æœ‰åŠ¹å¿œå‹Ÿæ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |
| is_connected | boolean | é€šé›»ãƒ•ãƒ©ã‚° | **é€šé›»æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |
| sms_sent_flag | boolean | SMSé€ä¿¡ãƒ•ãƒ©ã‚° | **SMSé€ä¿¡æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |
| first_interview_attended | boolean | åˆå›é¢è«‡å‡ºå¸­ | **ç€åº§æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |

---

#### `candidate_applications` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¿œå‹Ÿæƒ…å ±ï¼‰

**KPIè¨ˆç®—ã®ä¸­æ ¸ãƒ†ãƒ¼ãƒ–ãƒ«**

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | ç”¨é€” | KPIè¨ˆç®—ã§ã®å½¹å‰² |
|---------|---------|------|----------------|
| id | bigint | å¿œå‹ŸID | ä¸»ã‚­ãƒ¼ |
| candidate_id | bigint | å€™è£œè€…ID | JOINç”¨ |
| client_id | bigint | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¼æ¥­ID | JOINç”¨ |
| recommended_at | timestamptz | æ¨è–¦æ—¥æ™‚ | **æ¨è–¦æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |
| first_interview_set_at | timestamptz | ä¸€æ¬¡é¢æ¥è¨­å®šæ—¥æ™‚ | **é¢æ¥è¨­å®šæ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |
| first_interview_at | timestamptz | ä¸€æ¬¡é¢æ¥å®Ÿæ–½æ—¥æ™‚ | **é¢æ¥å®Ÿæ–½æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |
| second_interview_set_at | timestamptz | äºŒæ¬¡é¢æ¥è¨­å®šæ—¥æ™‚ | ï¼ˆè¿½åŠ ã‚«ã‚¦ãƒ³ãƒˆï¼‰ |
| second_interview_at | timestamptz | äºŒæ¬¡é¢æ¥å®Ÿæ–½æ—¥æ™‚ | ï¼ˆè¿½åŠ ã‚«ã‚¦ãƒ³ãƒˆï¼‰ |
| final_interview_set_at | date | æœ€çµ‚é¢æ¥è¨­å®šæ—¥ | ï¼ˆè¿½åŠ ã‚«ã‚¦ãƒ³ãƒˆï¼‰ |
| final_interview_at | date | æœ€çµ‚é¢æ¥å®Ÿæ–½æ—¥ | ï¼ˆè¿½åŠ ã‚«ã‚¦ãƒ³ãƒˆï¼‰ |
| offer_at | date | å†…å®šæ—¥ | **å†…å®šæ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |
| offer_accepted_at | date | æ‰¿è«¾æ—¥ | **æ‰¿è«¾æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |
| joined_at | date | å…¥ç¤¾æ—¥ | **å…¥ç¤¾æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ** |
| declined_after_offer_at | date | å†…å®šå¾Œè¾é€€æ—¥ | å¤±æ³¨ã®åˆ¤å®š |
| early_turnover_at | date | æ—©æœŸé€€è·æ—¥ | æ—©æœŸé€€è·ã®åˆ¤å®š |
| stage_current | text | ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ |
| created_at | timestamptz | ä½œæˆæ—¥æ™‚ | **å¿œå‹Ÿï¼ˆææ¡ˆï¼‰æ—¥æ™‚** |

---

#### [clients](file:///Users/riho/Documents/GitHub/AI-/archive/unused-20260127/lambda_backup/aws-toolkit-ap-northeast-1/.ats-api-dev-kpi-clients) ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¼æ¥­ï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | ç”¨é€” |
|---------|---------|------|
| id | bigint | ä¼æ¥­ID |
| name | text | ä¼æ¥­å |

---

#### `users` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | ç”¨é€” |
|---------|---------|------|
| id | bigint | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| name | text | æ°å |
| email | text | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| role | text | ãƒ­ãƒ¼ãƒ«ï¼ˆadvisorã€callerã€adminï¼‰ |

---

#### `placements` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæˆç´„ãƒ»ç´¹ä»‹æ–™ï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | ç”¨é€” |
|---------|---------|------|
| id | bigint | ID |
| candidate_application_id | bigint | å¿œå‹ŸID |
| fee_amount | integer | ç´¹ä»‹æ–™é‡‘é¡ï¼ˆ**å£²ä¸Šè¨ˆç®—**ï¼‰ |
| refund_amount | integer | è¿”é‡‘é¡ |

---

### 1.2 ç›®æ¨™ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«

#### `goal_targets` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæœŸé–“ç›®æ¨™ï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | ç”¨é€” |
|---------|---------|------|
| scope | text | ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆpersonalã€companyï¼‰ |
| advisor_user_id | integer | ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ID |
| period_id | text | æœŸé–“IDï¼ˆYYYY-MMå½¢å¼ï¼‰ |
| targets | jsonb | ç›®æ¨™å€¤ï¼ˆJSONï¼‰ |

**targets JSONã®æ§‹é€ **:
```json
{
  "newInterviewsTarget": 50,
  "proposalsTarget": 40,
  "recommendationsTarget": 30,
  "interviewsScheduledTarget": 25,
  "interviewsHeldTarget": 20,
  "offersTarget": 10,
  "acceptsTarget": 8,
  "proposalRateTarget": 80,
  "recommendationRateTarget": 60,
  "interviewScheduleRateTarget": 50,
  "interviewHeldRateTarget": 40,
  "offerRateTarget": 20,
  "acceptRateTarget": 16,
  "hireRateTarget": 14,
  "revenueTarget": 500000
}
```

#### `goal_daily_targets` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ—¥æ¬¡ç›®æ¨™ï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | ç”¨é€” |
|---------|---------|------|
| advisor_user_id | integer | ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ID |
| period_id | text | æœŸé–“ID |
| target_date | date | å¯¾è±¡æ—¥ |
| targets | jsonb | æ—¥åˆ¥ç›®æ¨™å€¤ï¼ˆJSONï¼‰ |

---

## 2. KPIæŒ‡æ¨™ã®è©³ç´°å®šç¾©

### 2.1 åŸºæœ¬KPIæŒ‡æ¨™

| æŒ‡æ¨™å | è‹±èªã‚­ãƒ¼ | ç®—å‡ºå…ƒãƒ†ãƒ¼ãƒ–ãƒ« | ç®—å‡ºæ¡ä»¶ |
|--------|---------|--------------|---------|
| æ–°è¦é¢è«‡æ•° | `newInterviews` | [candidates](file:///Users/riho/Documents/GitHub/AI-/pages/candidates/candidates.js#12-13) | `first_contact_at IS NOT NULL` |
| ææ¡ˆæ•° | `proposals` | `candidate_applications` | `created_at` ã§ã‚«ã‚¦ãƒ³ãƒˆ |
| æ¨è–¦æ•° | `recommendations` | `candidate_applications` | `recommended_at IS NOT NULL` |
| é¢æ¥è¨­å®šæ•° | `interviewsScheduled` | `candidate_applications` | `first_interview_set_at IS NOT NULL` |
| é¢æ¥å®Ÿæ–½æ•° | `interviewsHeld` | `candidate_applications` | `first_interview_at IS NOT NULL` |
| å†…å®šæ•° | `offers` | `candidate_applications` | `offer_at IS NOT NULL` |
| æ‰¿è«¾æ•° | `accepts` | `candidate_applications` | `offer_accepted_at IS NOT NULL` |
| å…¥ç¤¾æ•° | `hires` | `candidate_applications` | `joined_at IS NOT NULL` |

---

### 2.2 è»¢æ›ç‡æŒ‡æ¨™

#### Base ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ–°è¦é¢è«‡æ•°ã‚’åˆ†æ¯ï¼‰

| æŒ‡æ¨™å | è‹±èªã‚­ãƒ¼ | è¨ˆç®—å¼ |
|--------|---------|--------|
| ææ¡ˆç‡ | `proposalRate` | [(ææ¡ˆæ•° / æ–°è¦é¢è«‡æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| æ¨è–¦ç‡ | `recommendationRate` | [(æ¨è–¦æ•° / æ–°è¦é¢è«‡æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| é¢æ¥è¨­å®šç‡ | `interviewScheduleRate` | [(é¢æ¥è¨­å®šæ•° / æ–°è¦é¢è«‡æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| é¢æ¥å®Ÿæ–½ç‡ | `interviewHeldRate` | [(é¢æ¥å®Ÿæ–½æ•° / æ–°è¦é¢è«‡æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| å†…å®šç‡ | `offerRate` | [(å†…å®šæ•° / æ–°è¦é¢è«‡æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| æ‰¿è«¾ç‡ | `acceptRate` | [(æ‰¿è«¾æ•° / æ–°è¦é¢è«‡æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| å…¥ç¤¾æ±ºå®šç‡ | `hireRate` | [(å…¥ç¤¾æ•° / æ–°è¦é¢è«‡æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |

#### Step ãƒ¢ãƒ¼ãƒ‰ï¼ˆå‰æ®µéšã‚’åˆ†æ¯ï¼‰

| æŒ‡æ¨™å | è‹±èªã‚­ãƒ¼ | è¨ˆç®—å¼ |
|--------|---------|--------|
| ææ¡ˆç‡ | `proposalRate` | [(ææ¡ˆæ•° / æ–°è¦é¢è«‡æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| æ¨è–¦ç‡ | `recommendationRate` | [(æ¨è–¦æ•° / ææ¡ˆæ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| é¢æ¥è¨­å®šç‡ | `interviewScheduleRate` | [(é¢æ¥è¨­å®šæ•° / æ¨è–¦æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| é¢æ¥å®Ÿæ–½ç‡ | `interviewHeldRate` | [(é¢æ¥å®Ÿæ–½æ•° / é¢æ¥è¨­å®šæ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| å†…å®šç‡ | `offerRate` | [(å†…å®šæ•° / é¢æ¥å®Ÿæ–½æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| æ‰¿è«¾ç‡ | `acceptRate` | [(æ‰¿è«¾æ•° / å†…å®šæ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |
| å…¥ç¤¾æ±ºå®šç‡ | `hireRate` | [(å…¥ç¤¾æ•° / æ‰¿è«¾æ•°) Ã— 100](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#1232-1236) |

---

## 3. è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰

### 3.1 Cohort ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¿œå‹Ÿæ™‚æœŸå„ªå…ˆï¼‰

**åŸºæº–æ—¥**: å€™è£œè€…ã®å¿œå‹Ÿæ—¥ï¼ˆ`candidates.created_at`ï¼‰

**è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**:
- æŒ‡å®šæœŸé–“å†…ã«å¿œå‹Ÿã—ãŸå€™è£œè€…ã‚’å¯¾è±¡
- ãã®å€™è£œè€…ãŒæœŸé–“å¤–ã«é”æˆã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚‚ã‚«ã‚¦ãƒ³ãƒˆ

**ä¾‹**:
- 1æœˆã«å¿œå‹Ÿã—ãŸå€™è£œè€…ãŒ2æœˆã«é¢æ¥ â†’ **1æœˆã®é¢æ¥æ•°ã«ã‚«ã‚¦ãƒ³ãƒˆ**

**SQLä¾‹**:
```sql
SELECT 
  COUNT(DISTINCT c.id) FILTER (WHERE c.created_at BETWEEN '2025-01-01' AND '2025-01-31') AS new_interviews,
  COUNT(DISTINCT ca.id) FILTER (
    WHERE ca.recommended_at IS NOT NULL 
    AND c.created_at BETWEEN '2025-01-01' AND '2025-01-31'
  ) AS recommendations
FROM candidates c
LEFT JOIN candidate_applications ca ON c.id = ca.candidate_id
WHERE c.advisor_user_id = 30;
```

---

### 3.2 Period ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å„ªå…ˆï¼‰

**åŸºæº–æ—¥**: å„ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç”Ÿæ—¥

**è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**:
- æŒ‡å®šæœŸé–“å†…ã«ç™ºç”Ÿã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚«ã‚¦ãƒ³ãƒˆ
- å¿œå‹Ÿæ—¥ã¯å•ã‚ãªã„

**ä¾‹**:
- 1æœˆã«å¿œå‹Ÿã—ãŸå€™è£œè€…ãŒ2æœˆã«é¢æ¥ â†’ **2æœˆã®é¢æ¥æ•°ã«ã‚«ã‚¦ãƒ³ãƒˆ**

**SQLä¾‹**:
```sql
SELECT 
  COUNT(DISTINCT c.id) FILTER (WHERE c.first_contact_at BETWEEN '2025-01-01' AND '2025-01-31') AS new_interviews,
  COUNT(DISTINCT ca.id) FILTER (WHERE ca.recommended_at BETWEEN '2025-01-01' AND '2025-01-31') AS recommendations
FROM candidates c
LEFT JOIN candidate_applications ca ON c.id = ca.candidate_id
WHERE c.advisor_user_id = 30;
```

---

## 4. Lambdaé–¢æ•°ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

### 4.1 [ats-api-dev-kpi-yield](file:///Users/riho/Documents/GitHub/AI-/archive/unused-20260127/lambda_backup/aws-toolkit-ap-northeast-1/.ats-api-dev-kpi-yield) (KPIé›†è¨ˆ)

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /kpi/yield`

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
```
?from=2025-01-01
&to=2025-01-31
&scope=personal          # personal | company
&granularity=summary     # summary | day | week | month
&groupBy=none            # none | advisor
&advisorUserId=30
&calcMode=cohort         # cohort | period
&countBasis=application  # application | event
&timeBasis=application   # application | event
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

```javascript
// 1. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ
const { from, to, scope, advisorUserId, granularity, groupBy, calcMode } = query;

// 2. åŸºæº–æ—¥ã®æ±ºå®š
const useCohort = calcMode === 'cohort';
const baseColumn = useCohort ? 'c.created_at' : 'event_date';

// 3. SQLæ§‹ç¯‰
const sql = `
  WITH base_candidates AS (
    SELECT c.id, c.advisor_user_id, c.created_at
    FROM candidates c
    WHERE ${useCohort ? `c.created_at BETWEEN $1 AND $2` : `c.first_contact_at BETWEEN $1 AND $2`}
      ${scope === 'personal' ? `AND c.advisor_user_id = $3` : ''}
  ),
  applications AS (
    SELECT 
      bc.id AS candidate_id,
      bc.advisor_user_id,
      bc.created_at AS application_date,
      ca.id AS application_id,
      ca.created_at AS proposal_date,
      ca.recommended_at,
      ca.first_interview_set_at,
      ca.first_interview_at,
      ca.offer_at,
      ca.offer_accepted_at,
      ca.joined_at
    FROM base_candidates bc
    LEFT JOIN candidate_applications ca ON bc.id = ca.candidate_id
  )
  SELECT 
    advisor_user_id,
    COUNT(DISTINCT candidate_id) AS new_interviews,
    COUNT(DISTINCT CASE WHEN proposal_date IS NOT NULL THEN application_id END) AS proposals,
    COUNT(DISTINCT CASE WHEN recommended_at IS NOT NULL THEN application_id END) AS recommendations,
    COUNT(DISTINCT CASE WHEN first_interview_set_at IS NOT NULL THEN application_id END) AS interviews_scheduled,
    COUNT(DISTINCT CASE WHEN first_interview_at IS NOT NULL THEN application_id END) AS interviews_held,
    COUNT(DISTINCT CASE WHEN offer_at IS NOT NULL THEN application_id END) AS offers,
    COUNT(DISTINCT CASE WHEN offer_accepted_at IS NOT NULL THEN application_id END) AS accepts,
    COUNT(DISTINCT CASE WHEN joined_at IS NOT NULL THEN application_id END) AS hires
  FROM applications
  ${groupBy === 'advisor' ? 'GROUP BY advisor_user_id' : ''}
`;

// 4. è»¢æ›ç‡è¨ˆç®—
const calculateRates = (counts, mode) => {
  const base = mode === 'base' ? counts.newInterviews : null;
  
  return {
    proposalRate: calcRate(counts.proposals, base || counts.newInterviews),
    recommendationRate: calcRate(counts.recommendations, base || counts.proposals),
    interviewScheduleRate: calcRate(counts.interviewsScheduled, base || counts.recommendations),
    interviewHeldRate: calcRate(counts.interviewsHeld, base || counts.interviewsScheduled),
    offerRate: calcRate(counts.offers, base || counts.interviewsHeld),
    acceptRate: calcRate(counts.accepts, base || counts.offers),
    hireRate: calcRate(counts.hires, base || counts.accepts)
  };
};

const calcRate = (numerator, denominator) => {
  if (!denominator || denominator === 0) return 0;
  return Math.round((numerator / denominator) * 100 * 10) / 10;
};
```

---

### 4.2 æ—¥åˆ¥é›†è¨ˆï¼ˆgranularity=dayï¼‰

**SQLä¾‹**:
```sql
SELECT 
  DATE(${useCohort ? 'c.created_at' : 'event_date'}) AS date,
  advisor_user_id,
  COUNT(DISTINCT c.id) FILTER (WHERE c.first_contact_at IS NOT NULL) AS new_interviews,
  COUNT(DISTINCT ca.id) FILTER (WHERE ca.created_at IS NOT NULL) AS proposals,
  COUNT(DISTINCT ca.id) FILTER (WHERE ca.recommended_at IS NOT NULL) AS recommendations,
  COUNT(DISTINCT ca.id) FILTER (WHERE ca.first_interview_set_at IS NOT NULL) AS interviews_scheduled,
  COUNT(DISTINCT ca.id) FILTER (WHERE ca.first_interview_at IS NOT NULL) AS interviews_held,
  COUNT(DISTINCT ca.id) FILTER (WHERE ca.offer_at IS NOT NULL) AS offers,
  COUNT(DISTINCT ca.id) FILTER (WHERE ca.offer_accepted_at IS NOT NULL) AS accepts,
  COUNT(DISTINCT ca.id) FILTER (WHERE ca.joined_at IS NOT NULL) AS hires
FROM candidates c
LEFT JOIN candidate_applications ca ON c.id = ca.candidate_id
WHERE c.created_at BETWEEN $1 AND $2
  AND c.advisor_user_id = $3
GROUP BY DATE(c.created_at), advisor_user_id
ORDER BY date;
```

---

## 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…

### 5.1 ä¸»è¦ãªé–¢æ•°

#### [fetchPersonalKpiFromApi({ startDate, endDate, planned })](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#343-359)

```javascript
async function fetchPersonalKpiFromApi({ startDate, endDate, planned = false }) {
  const advisorUserId = await resolveAdvisorUserId();
  
  const params = {
    from: startDate,
    to: endDate,
    scope: 'personal',
    advisorUserId,
    granularity: 'summary',
    groupBy: 'none',
    ...buildCalcModeParams()  // calcMode, countBasis, timeBasis
  };
  
  if (planned) params.planned = '1';
  
  const json = await fetchJson(`${KPI_API_BASE}/yield`, params);
  return json?.items?.[0]?.kpi || null;
}
```

---

#### [fetchDailyYieldFromApi({ startDate, endDate, advisorUserId })](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#374-399)

```javascript
async function fetchDailyYieldFromApi({ startDate, endDate, advisorUserId }) {
  const params = {
    from: startDate,
    to: endDate,
    scope: 'company',
    granularity: 'day',       // æ—¥åˆ¥é›†è¨ˆ
    groupBy: 'advisor',       // ç¤¾å“¡åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    ...buildCalcModeParams()
  };
  
  const json = await fetchJson(`${KPI_API_BASE}/yield`, params);
  const rawItems = Array.isArray(json?.items) ? json.items : [];
  
  // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã¨ãƒãƒ¼ã‚¸
  const items = await mergeMembersWithDailyItems(rawItems);
  
  // ç¤¾å“¡åˆ¥ãƒ‡ãƒ¼ã‚¿ã«æ•´å½¢
  const employees = items.map(item => ({
    advisorUserId: item?.advisorUserId,
    name: item?.name || `ID:${item?.advisorUserId}`,
    daily: item?.series || {}  // { "2025-01-01": { newInterviews: 5, ... }, ... }
  }));
  
  return { personal: ..., employees };
}
```

---

### 5.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

#### æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```javascript
const dailyYieldCache = new Map();

async function ensureDailyYieldData(periodId) {
  const period = state.evaluationPeriods.find(item => item.id === periodId);
  const advisorUserId = await resolveAdvisorUserId();
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼: periodId + advisorUserId + calcMode
  const cacheKey = `${periodId}:${advisorUserId || 'none'}:${getCalcMode()}`;
  
  if (dailyYieldCache.has(cacheKey)) {
    return dailyYieldCache.get(cacheKey);
  }
  
  const payload = await fetchDailyYieldFromApi({
    startDate: period.startDate,
    endDate: period.endDate,
    advisorUserId
  });
  
  dailyYieldCache.set(cacheKey, payload);
  return payload;
}
```

---

### 5.3 æ­£è¦åŒ–é–¢æ•°

#### [normalizeKpi(kpi)](file:///Users/riho/Documents/GitHub/AI-/pages/yield/yield.js#3778-3791)

```javascript
function normalizeKpi(kpi = {}) {
  return {
    newInterviews: num(kpi.newInterviews ?? kpi.new_interviews),
    proposals: num(kpi.proposals),
    recommendations: num(kpi.recommendations),
    interviewsScheduled: num(kpi.interviewsScheduled ?? kpi.interviews_scheduled),
    interviewsHeld: num(kpi.interviewsHeld ?? kpi.interviews_held),
    offers: num(kpi.offers),
    accepts: num(kpi.accepts),
    hires: num(kpi.hires),
    
    // è»¢æ›ç‡
    proposalRate: num(kpi.proposalRate ?? kpi.proposal_rate),
    recommendationRate: num(kpi.recommendationRate ?? kpi.recommendation_rate),
    interviewScheduleRate: num(kpi.interviewScheduleRate ?? kpi.interview_schedule_rate),
    interviewHeldRate: num(kpi.interviewHeldRate ?? kpi.interview_held_rate),
    offerRate: num(kpi.offerRate ?? kpi.offer_rate),
    acceptRate: num(kpi.acceptRate ?? kpi.accept_rate),
    hireRate: num(kpi.hireRate ?? kpi.hire_rate),
    
    // ãã®ä»–
    revenue: num(kpi.revenue),
    achievementRate: num(kpi.achievementRate ?? kpi.achievement_rate)
  };
}
```

---

## 6. MSï¼ˆManagement Summaryï¼‰ç®¡ç†

### 6.1 éƒ¨é–€åˆ¥è¨­å®š

#### ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨é–€

| æŒ‡æ¨™ | targetKey |
|------|-----------|
| æœ‰åŠ¹å¿œå‹Ÿæ•° | `validApplications` |

**æœŸé–“**: å‰æœˆ17æ—¥ ã€œ å½“æœˆ20æ—¥

---

#### CSéƒ¨é–€

| æŒ‡æ¨™ | targetKey |
|------|-----------|
| è¨­å®šæ•° | `appointments` |
| ç€åº§æ•° | `sitting` |

**æœŸé–“**: å‰æœˆ18æ—¥ ã€œ å½“æœˆ21æ—¥

---

#### å–¶æ¥­éƒ¨é–€

| æŒ‡æ¨™ | targetKey |
|------|-----------|
| æ–°è¦é¢è«‡æ•° | `newInterviews` |
| ææ¡ˆæ•° | `proposals` |
| æ¨è–¦æ•° | `recommendations` |
| é¢æ¥è¨­å®šæ•° | `interviewSettings` |
| é¢æ¥å®Ÿæ–½æ•° | `interviewExecutions` |
| å†…å®šæ•° | `offers` |
| æ‰¿è«¾æ•° | `acceptances` |

**æœŸé–“**: å‰æœˆ18æ—¥ ã€œ å½“æœˆ21æ—¥

---

### 6.2 MSç›®æ¨™ç®¡ç†

**MSãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ **:

```javascript
state.companyMs = {
  metricKeys: {
    marketing: 'validApplications',  // æŒ‡æ¨™é¸æŠ
    cs: 'appointments',
    sales: 'newInterviews'
  },
  dates: ['2025-01-17', '2025-01-18', ...],  // å¯¾è±¡æ—¥ä»˜
  
  msTargets: {
    marketing: {
      '2025-01-17': 10,  // æ—¥åˆ¥MSç›®æ¨™
      '2025-01-18': 10
    },
    cs: { ... },
    sales: { ... }
  },
  
  msActuals: {
    marketing: {
      '2025-01-17': 8,   // æ—¥åˆ¥å®Ÿç¸¾
      '2025-01-18': 12
    },
    cs: { ... },
    sales: { ... }
  }
};
```

---

## 7. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å…¨ä½“å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ                                             â”‚
â”‚ - æœŸé–“é¸æŠ                                               â”‚
â”‚ - è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆcohort/periodï¼‰                        â”‚
â”‚ - ç‡è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆbase/stepï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆyield.jsï¼‰                               â”‚
â”‚ - loadYieldData()                                        â”‚
â”‚ - fetchPersonalKpiFromApi()                              â”‚
â”‚ - fetchCompanyKpiFromApi()                               â”‚
â”‚ - fetchDailyYieldFromApi()                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP GET /kpi/yield?...
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lambdaé–¢æ•°ï¼ˆats-api-dev-kpi-yieldï¼‰                      â”‚
â”‚ 1. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ                                        â”‚
â”‚ 2. è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆcohort/periodï¼‰                      â”‚
â”‚ 3. SQLæ§‹ç¯‰                                               â”‚
â”‚ 4. PostgreSQL ã‚¯ã‚¨ãƒªå®Ÿè¡Œ                                 â”‚
â”‚ 5. è»¢æ›ç‡è¨ˆç®—                                            â”‚
â”‚ 6. JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL                                               â”‚
â”‚ - candidatesï¼ˆå€™è£œè€…ï¼‰                                   â”‚
â”‚   â””â”€ advisor_user_id, created_at, first_contact_at      â”‚
â”‚ - candidate_applicationsï¼ˆå¿œå‹Ÿï¼‰                         â”‚
â”‚   â””â”€ recommended_at, first_interview_at, offer_at, ...  â”‚
â”‚ - placementsï¼ˆç´¹ä»‹æ–™ï¼‰                                   â”‚
â”‚   â””â”€ fee_amount                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹                                             â”‚
â”‚ {                                                        â”‚
â”‚   "items": [{                                            â”‚
â”‚     "advisorUserId": 30,                                 â”‚
â”‚     "kpi": {                                             â”‚
â”‚       "newInterviews": 50,                               â”‚
â”‚       "proposals": 40,                                   â”‚
â”‚       "recommendations": 30,                             â”‚
â”‚       "interviewsScheduled": 25,                         â”‚
â”‚       "interviewsHeld": 20,                              â”‚
â”‚       "offers": 10,                                      â”‚
â”‚       "accepts": 8,                                      â”‚
â”‚       "hires": 7,                                        â”‚
â”‚       "proposalRate": 80.0,                              â”‚
â”‚       "recommendationRate": 60.0,                        â”‚
â”‚       ...                                                â”‚
â”‚     }                                                    â”‚
â”‚   }]                                                     â”‚
â”‚ }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 8.1 ä¸¦åˆ—å‡¦ç†

```javascript
// è¤‡æ•°æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦åˆ—å–å¾—
await Promise.all([
  fetchPersonalKpiFromApi({ startDate: '2025-01-01', endDate: '2025-01-31' }),
  fetchCompanyKpiFromApi({ startDate: '2025-01-01', endDate: '2025-01-31' }),
  fetchDailyYieldFromApi({ startDate: '2025-01-01', endDate: '2025-01-31', advisorUserId: 30 })
]);
```

### 8.2 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

**æ¨å¥¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
```sql
-- candidatesãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_candidates_advisor_created ON candidates (advisor_user_id, created_at);
CREATE INDEX idx_candidates_first_contact ON candidates (first_contact_at);

-- candidate_applicationsãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_applications_candidate ON candidate_applications (candidate_id);
CREATE INDEX idx_applications_recommended ON candidate_applications (recommended_at);
CREATE INDEX idx_applications_first_interview_set ON candidate_applications (first_interview_set_at);
CREATE INDEX idx_applications_first_interview ON candidate_applications (first_interview_at);
CREATE INDEX idx_applications_offer ON candidate_applications (offer_at);
CREATE INDEX idx_applications_offer_accepted ON candidate_applications (offer_accepted_at);
CREATE INDEX idx_applications_joined ON candidate_applications (joined_at);
```

---

## 9. ã¾ã¨ã‚

### ä½¿ç”¨ã™ã‚‹DBãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¸»è¦4ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

1. **candidates**: å€™è£œè€…åŸºæœ¬æƒ…å ±ï¼ˆæ–°è¦é¢è«‡æ•°ã®ç®—å‡ºï¼‰
2. **candidate_applications**: å¿œå‹Ÿãƒ»é¸è€ƒæƒ…å ±ï¼ˆKPIè¨ˆç®—ã®ä¸­æ ¸ï¼‰
3. **users**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼åã®è§£æ±ºï¼‰
4. **placements**: ç´¹ä»‹æ–™ï¼ˆå£²ä¸Šã®ç®—å‡ºï¼‰

### è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰

- **Cohort**: å¿œå‹Ÿæ™‚æœŸã‚’åŸºæº–ã«é›†è¨ˆ
- **Period**: ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚æœŸã‚’åŸºæº–ã«é›†è¨ˆ

### ç‡è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰

- **Base**: ã™ã¹ã¦ã®ç‡ã‚’æ–°è¦é¢è«‡æ•°ã§å‰²ã‚‹
- **Step**: å„æ®µéšã®å‰æ®µéšã®æ•°ã§å‰²ã‚‹

### Lambdaé–¢æ•°ã®å½¹å‰²

- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¿œã˜ã¦SQLã‚’å‹•çš„ã«æ§‹ç¯‰
- DB ã‹ã‚‰ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
- è»¢æ›ç‡ã‚’è¨ˆç®—
- JSONå½¢å¼ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å½¹å‰²

- APIå‘¼ã³å‡ºã—
- ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–ï¼ˆsnake_case â†’ camelCaseï¼‰
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
- UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

â€¦â€¦ã“ã‚Œã§æ­©ç•™ã¾ã‚Šç®¡ç†ç”»é¢ã®å…¨ä½“åƒãŒã‚ã‹ã£ãŸã¨æ€ã†ã‚ˆã€‚è³ªå•ãŒã‚ã£ãŸã‚‰æ•™ãˆã¦ã­ï¼
