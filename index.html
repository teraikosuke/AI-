<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>業務ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans JP", "Inter", sans-serif;
      }
      .table-grid {
        width: 100%;
        border-collapse: collapse;
      }
      .table-grid th,
      .table-grid td {
        border: 1px solid #d1d5db;
        padding: 0.65rem 0.75rem;
        font-size: 0.85rem;
        background-color: #ffffff;
      }
      .table-grid thead th {
        position: sticky;
        top: 0;
        background-color: #f8fafc;
        z-index: 5;
      }
      .table-grid tbody tr:nth-child(even) td {
        background-color: #f1f5f9;
      }
      .table-grid tbody tr:hover td {
        background-color: #e2e8f0;
      }
      .table-grid .fixed-col {
        position: sticky;
        left: 0;
        background-color: #eef2ff;
        z-index: 4;
      }
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
      }
      .kpi-card {
        background: linear-gradient(135deg, #eef2ff 0%, #e0f2fe 100%);
        border: 1px solid #c7d2fe;
        border-radius: 0.85rem;
        padding: 1rem 1.25rem;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      }
      .kpi-card strong {
        display: block;
        color: #1e293b;
        font-size: 1rem;
        margin-bottom: 0.4rem;
      }
      .kpi-card span {
        font-weight: 600;
        font-size: 1.25rem;
        color: #0f172a;
      }
      .section-shell {
        background-color: #ffffff;
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        padding: 1.5rem;
        box-shadow: 0 12px 45px rgba(15, 23, 42, 0.08);
      }
      .phase-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.6rem;
        border-radius: 9999px;
        border: 1px solid #cbd5f5;
        background-color: #e8edff;
        color: #1e3a8a;
        font-size: 0.7rem;
        font-weight: 600;
        margin: 0.15rem 0.2rem;
      }
      .phase-chip.active {
        background-color: #4338ca;
        border-color: #312e81;
        color: #ffffff;
      }
      .phase-chip.pending {
        background-color: #f1f5f9;
        border-color: #cbd5f5;
        color: #475569;
      }
      .drawer-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        z-index: 40;
      }
      .detail-drawer {
        position: fixed;
        top: 0;
        right: -480px;
        width: 420px;
        max-width: 100%;
        height: 100%;
        background: #ffffff;
        box-shadow: -16px 0 32px rgba(15, 23, 42, 0.2);
        transition: right 0.3s ease;
        z-index: 50;
        display: flex;
        flex-direction: column;
      }
      .detail-drawer.open {
        right: 0;
      }
      .drawer-overlay.visible {
        display: block;
      }
      .timeline-item {
        border-left: 3px solid #cbd5f5;
        padding-left: 1rem;
        margin-left: 0.6rem;
        position: relative;
        margin-bottom: 1rem;
      }
      .timeline-item::before {
        content: "";
        position: absolute;
        left: -0.78rem;
        top: 0.15rem;
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 9999px;
        background: #4338ca;
        box-shadow: 0 0 0 4px #e8edff;
      }
      .timeline-item:last-child {
        margin-bottom: 0;
      }
      #sidebar.sidebar-collapsed {
        width: 4.5rem;
      }
      #sidebar.sidebar-collapsed .sidebar-title-text,
      #sidebar.sidebar-collapsed .nav-label {
        display: none;
      }
      #sidebar.sidebar-collapsed .nav-link {
        justify-content: center;
      }
      #sidebar.sidebar-collapsed .nav-dot {
        width: 0.6rem;
        height: 0.6rem;
      }
      #sidebar.sidebar-collapsed + .flex-1 {
        flex: 1;
      }
    </style>
  </head>
  <body class="bg-slate-100">
    <div class="flex min-h-screen transition-all duration-300">
      <aside
        id="sidebar"
        class="w-64 bg-slate-900 text-slate-100 flex flex-col transition-all duration-300 ease-in-out"
      >
        <div
          class="px-6 py-5 border-b border-slate-700 flex items-start justify-between gap-3"
        >
          <div>
            <p
              class="text-sm uppercase tracking-wide text-slate-400 sidebar-title-text"
            >
              Recruiting Ops
            </p>
            <h1 class="text-xl font-semibold mt-2 sidebar-title-text">
              業務ダッシュボード
            </h1>
          </div>
          <button
            id="sidebarToggle"
            class="mt-1 px-2 py-1 text-xs font-semibold bg-slate-800 hover:bg-slate-700 rounded-md border border-slate-700 transition"
            aria-label="サイドバーの開閉"
            type="button"
          >
            ⪡⪢
          </button>
        </div>
        <nav class="flex-1 overflow-y-auto">
          <ul class="px-3 py-4 space-y-1">
            <li>
              <button
                data-target="yield"
                class="nav-link w-full text-left px-4 py-3 rounded-lg transition hover:bg-slate-800 hover:text-white bg-slate-800 text-white whitespace-nowrap flex items-center justify-start gap-3"
              >
                <span class="nav-dot w-2 h-2 rounded-full bg-indigo-400"></span>
                <span class="nav-label">歩留管理（総合）</span>
              </button>
            </li>
            <li>
              <button
                data-target="candidates"
                class="nav-link w-full text-left px-4 py-3 rounded-lg transition hover:bg-slate-800 hover:text-white whitespace-nowrap flex items-center justify-start gap-3"
              >
                <span class="nav-dot w-2 h-2 rounded-full bg-slate-500"></span>
                <span class="nav-label">候補者管理</span>
              </button>
            </li>
            <li>
              <button
                data-target="ad-spend"
                class="nav-link w-full text-left px-4 py-3 rounded-lg transition hover:bg-slate-800 hover:text-white whitespace-nowrap flex items-center justify-start gap-3"
              >
                <span class="nav-dot w-2 h-2 rounded-full bg-slate-500"></span>
                <span class="nav-label">広告費管理</span>
              </button>
            </li>
            <li>
              <button
                data-target="referral"
                class="nav-link w-full text-left px-4 py-3 rounded-lg transition hover:bg-slate-800 hover:text-white whitespace-nowrap flex items-center justify-start gap-3"
              >
                <span class="nav-dot w-2 h-2 rounded-full bg-slate-500"></span>
                <span class="nav-label">紹介実績管理</span>
              </button>
            </li>
            <li>
              <button
                data-target="tele-ops"
                class="nav-link w-full text-left px-4 py-3 rounded-lg transition hover:bg-slate-800 hover:text-white whitespace-nowrap flex items-center justify-start gap-3"
              >
                <span class="nav-dot w-2 h-2 rounded-full bg-slate-500"></span>
                <span class="nav-label">テレアポ実績管理</span>
              </button>
            </li>
            <li>
              <button
                data-target="ad-performance"
                class="nav-link w-full text-left px-4 py-3 rounded-lg transition hover:bg-slate-800 hover:text-white whitespace-nowrap flex items-center justify-start gap-3"
              >
                <span class="nav-dot w-2 h-2 rounded-full bg-slate-500"></span>
                <span class="nav-label">広告管理</span>
              </button>
            </li>
            <li>
              <button
                data-target="tele-log"
                class="nav-link w-full text-left px-4 py-3 rounded-lg transition hover:bg-slate-800 hover:text-white whitespace-nowrap flex items-center justify-start gap-3"
              >
                <span class="nav-dot w-2 h-2 rounded-full bg-slate-500"></span>
                <span class="nav-label">テレアポ管理</span>
              </button>
            </li>
          </ul>
        </nav>
        <div class="px-6 py-4 border-t border-slate-800 text-sm text-slate-400">
          保存済みビューや通知は次期開発で追加予定
        </div>
      </aside>

      <div class="flex-1 flex flex-col">
        <header class="bg-white border-b border-slate-200">
          <div
            class="flex flex-wrap items-center justify-between gap-4 px-6 py-4"
          >
            <div>
              <h2 id="pageTitle" class="text-2xl font-semibold text-slate-900">
                歩留管理（総合）
              </h2>
              <p id="pageSubtitle" class="text-sm text-slate-500 mt-1">
                フィルター適用後の歩留KPIとトレンドをスプレッドシート形式で確認
              </p>
            </div>
            <div class="flex items-center gap-2">
              <button
                class="px-3 py-2 rounded-lg border border-slate-300 text-sm font-medium hover:bg-slate-50 whitespace-nowrap"
              >
                ビューを保存
              </button>
              <button
                class="px-3 py-2 rounded-lg border border-slate-300 text-sm font-medium hover:bg-slate-50 whitespace-nowrap"
              >
                共有
              </button>
              <button
                class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-500 whitespace-nowrap"
              >
                CSVエクスポート
              </button>
            </div>
          </div>
          <div
            class="flex flex-wrap items-center gap-3 px-6 pb-4 border-t border-slate-200 pt-4 bg-slate-50"
          >
            <div class="flex flex-col text-xs text-slate-500">
              <label for="filter-period" class="mb-1"
                ><span class="whitespace-nowrap">期間</span></label
              >
              <select
                id="filter-period"
                class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
              >
                <option>今月</option>
                <option>先月</option>
                <option>四半期</option>
                <option>年度</option>
                <option>カスタム</option>
              </select>
            </div>
            <div class="flex flex-col text-xs text-slate-500">
              <label for="filter-role" class="mb-1"
                ><span class="whitespace-nowrap">職種</span></label
              >
              <select
                id="filter-role"
                class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
              >
                <option>すべて</option>
                <option>エンジニア</option>
                <option>セールス</option>
                <option>カスタマーサクセス</option>
              </select>
            </div>
            <div class="flex flex-col text-xs text-slate-500">
              <label for="filter-channel" class="mb-1"
                ><span class="whitespace-nowrap">媒体</span></label
              >
              <select
                id="filter-channel"
                class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
              >
                <option>すべて</option>
                <option>Indeed</option>
                <option>求人ボックス</option>
                <option>リクナビ</option>
              </select>
            </div>
            <div class="flex flex-col text-xs text-slate-500">
              <label for="filter-owner" class="mb-1"
                ><span class="whitespace-nowrap">担当者</span></label
              >
              <select
                id="filter-owner"
                class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
              >
                <option>すべて</option>
                <option>CAチーム</option>
                <option>CSチーム</option>
                <option>広告運用</option>
              </select>
            </div>
            <div class="flex-1"></div>
            <div class="flex flex-col text-xs text-slate-500">
              <label for="search" class="mb-1"
                ><span class="whitespace-nowrap">検索</span></label
              >
              <input
                id="search"
                type="search"
                class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                placeholder="候補者名や求人IDで検索"
              />
            </div>
            <button
              class="px-3 py-2 rounded-lg border border-slate-300 text-sm font-medium hover:bg-slate-100 whitespace-nowrap"
            >
              フィルターをリセット
            </button>
          </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 space-y-6">
          <section data-page="yield" class="page-section space-y-6">
            <!-- KPI v2: 個人成績・全体セクション -->
            <section data-kpi="v2" class="kpi-v2-wrapper space-y-6">
              <!-- 個人成績 -->
              <div class="kpi-v2-section">
                <div class="kpi-v2-header">
                  <h3 class="kpi-v2-title">個人成績</h3>
                  <div class="kpi-v2-range-picker">
                    <input type="date" id="personalRangeStart" class="kpi-v2-date-input" />
                    <span class="kpi-v2-date-separator">〜</span>
                    <input type="date" id="personalRangeEnd" class="kpi-v2-date-input" />
                  </div>
                </div>
                
                <!-- 売り上げ達成率と目標金額（統合カード） -->
                <div class="kpi-v2-summary-unified">
                  <div class="kpi-v2-achievement-section">
                    <div class="kpi-v2-label">売り上げ達成率</div>
                    <div class="kpi-v2-value kpi-v2-value-large" id="personalAchievementRate">33%</div>
                  </div>
                  <div class="kpi-v2-target-section">
                    <div class="kpi-v2-label">現状 / 目標金額</div>
                    <div class="kpi-v2-value">
                      <span class="kpi-v2-current" id="personalCurrent">¥957,000</span>
                      <span class="kpi-v2-separator">/</span>
                      <span class="kpi-v2-target" id="personalTarget">¥3,000,000</span>
                    </div>
                  </div>
                </div>

                <!-- 7KPI 数の行 -->
                <div class="kpi-v2-scroll-wrapper">
                  <div class="kpi-v2-row" data-kpi-type="counts">
                    <div class="kpi-v2-card" data-kpi="proposals">
                      <div class="kpi-v2-label">提案数</div>
                      <div class="kpi-v2-value" id="personalProposals">10</div>
                      <div class="kpi-v2-meta">新規面談数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="recommendations">
                      <div class="kpi-v2-label">推薦数</div>
                      <div class="kpi-v2-value" id="personalRecommendations">10</div>
                      <div class="kpi-v2-meta">推薦数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="interviewsScheduled">
                      <div class="kpi-v2-label">面談設定数</div>
                      <div class="kpi-v2-value" id="personalInterviewsScheduled">10</div>
                      <div class="kpi-v2-meta">面談設定数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="interviewsHeld">
                      <div class="kpi-v2-label">面談実施数</div>
                      <div class="kpi-v2-value" id="personalInterviewsHeld">10</div>
                      <div class="kpi-v2-meta">面談実施数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="offers">
                      <div class="kpi-v2-label">内定数</div>
                      <div class="kpi-v2-value" id="personalOffers">10</div>
                      <div class="kpi-v2-meta">内定数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="accepts">
                      <div class="kpi-v2-label">承諾数</div>
                      <div class="kpi-v2-value" id="personalAccepts">10</div>
                      <div class="kpi-v2-meta">承諾数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="hires">
                      <div class="kpi-v2-label">決定数</div>
                      <div class="kpi-v2-value" id="personalHires">10</div>
                      <div class="kpi-v2-meta">提案数 30(10)</div>
                    </div>
                  </div>
                </div>

                <!-- 7KPI 率の行 -->
                <div class="kpi-v2-scroll-wrapper">
                  <div class="kpi-v2-row" data-kpi-type="rates">
                    <div class="kpi-v2-card" data-kpi="proposalRate">
                      <div class="kpi-v2-label">提案率</div>
                      <div class="kpi-v2-value" id="personalProposalRate">33%</div>
                      <div class="kpi-v2-meta">提案数 10/ 新規面談数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="recommendationRate">
                      <div class="kpi-v2-label">推薦率</div>
                      <div class="kpi-v2-value" id="personalRecommendationRate">33%</div>
                      <div class="kpi-v2-meta">推薦数 10/ 提案数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="interviewScheduleRate">
                      <div class="kpi-v2-label">面談設定率</div>
                      <div class="kpi-v2-value" id="personalInterviewScheduleRate">33%</div>
                      <div class="kpi-v2-meta">面談設定数 10/ 推薦数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="interviewHeldRate">
                      <div class="kpi-v2-label">面談実施率</div>
                      <div class="kpi-v2-value" id="personalInterviewHeldRate">33%</div>
                      <div class="kpi-v2-meta">面談実施数 10/面談設定数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="offerRate">
                      <div class="kpi-v2-label">内定率</div>
                      <div class="kpi-v2-value" id="personalOfferRate">33%</div>
                      <div class="kpi-v2-meta">内定数 10/ 面談実施数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="acceptRate">
                      <div class="kpi-v2-label">承諾率</div>
                      <div class="kpi-v2-value" id="personalAcceptRate">33%</div>
                      <div class="kpi-v2-meta">承諾数 10/ 内定数 30(10)</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="hireRate">
                      <div class="kpi-v2-label">決定率</div>
                      <div class="kpi-v2-value" id="personalHireRate">33%</div>
                      <div class="kpi-v2-meta">決定数 10/ 提案数 30(10)</div>
                    </div>
                  </div>
                </div>

                <!-- 折れ線グラフ: 月次推移 -->
                <div class="kpi-v2-chart-section">
                  <h4 class="kpi-v2-chart-title">月次推移（直近6ヶ月）</h4>
                  <div class="kpi-v2-chart-container">
                    <svg id="personalTrendChart" class="kpi-v2-svg-chart" viewBox="0 0 800 300">
                      <!-- チャートはJavaScriptで描画 -->
                    </svg>
                    <div class="kpi-v2-chart-legend" id="personalChartLegend">
                      <!-- 凡例はJavaScriptで生成 -->
                    </div>
                  </div>
                  <div class="kpi-v2-chart-tooltip" id="personalChartTooltip"></div>
                </div>
              </div>

              <!-- 社内成績 -->
              <div class="kpi-v2-section">
                <div class="kpi-v2-header">
                  <h3 class="kpi-v2-title">社内成績</h3>
                  <div class="kpi-v2-range-picker">
                    <input type="date" id="companyRangeStart" class="kpi-v2-date-input" />
                    <span class="kpi-v2-date-separator">〜</span>
                    <input type="date" id="companyRangeEnd" class="kpi-v2-date-input" />
                  </div>
                </div>

                <!-- 全体成績 -->
                <div class="kpi-v2-subsection">
                  <h4 class="kpi-v2-subtitle">全体成績</h4>
                  
                  <!-- 全体 7KPI 数の行 -->
                  <div class="kpi-v2-scroll-wrapper">
                    <div class="kpi-v2-row" data-kpi-type="counts">
                      <div class="kpi-v2-card" data-kpi="proposals">
                        <div class="kpi-v2-label">提案数</div>
                        <div class="kpi-v2-value" id="companyProposals">127</div>
                        <div class="kpi-v2-meta">新規面談数 185(42)</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="recommendations">
                        <div class="kpi-v2-label">推薦数</div>
                        <div class="kpi-v2-value" id="companyRecommendations">89</div>
                        <div class="kpi-v2-meta">推薦数 89(27)</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="interviewsScheduled">
                        <div class="kpi-v2-label">面談設定数</div>
                        <div class="kpi-v2-value" id="companyInterviewsScheduled">156</div>
                        <div class="kpi-v2-meta">面談設定数 156(39)</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="interviewsHeld">
                        <div class="kpi-v2-label">面談実施数</div>
                        <div class="kpi-v2-value" id="companyInterviewsHeld">132</div>
                        <div class="kpi-v2-meta">面談実施数 132(28)</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="offers">
                        <div class="kpi-v2-label">内定数</div>
                        <div class="kpi-v2-value" id="companyOffers">68</div>
                        <div class="kpi-v2-meta">内定数 68(15)</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="accepts">
                        <div class="kpi-v2-label">承諾数</div>
                        <div class="kpi-v2-value" id="companyAccepts">41</div>
                        <div class="kpi-v2-meta">承諾数 41(9)</div>
                      </div>
                    </div>
                  </div>

                  <!-- 全体 7KPI 率の行 -->
                  <div class="kpi-v2-scroll-wrapper">
                    <div class="kpi-v2-row" data-kpi-type="rates">
                      <div class="kpi-v2-card" data-kpi="proposalRate">
                        <div class="kpi-v2-label">提案率</div>
                        <div class="kpi-v2-value" id="companyProposalRate">69%</div>
                        <div class="kpi-v2-meta">提案数 127/ 新規面談数 185(42)</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="recommendationRate">
                        <div class="kpi-v2-label">推薦率</div>
                        <div class="kpi-v2-value" id="companyRecommendationRate">70%</div>
                        <div class="kpi-v2-meta">推薦数 89/ 提案数 127(27)</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="interviewScheduleRate">
                        <div class="kpi-v2-label">面談設定率</div>
                        <div class="kpi-v2-value" id="companyInterviewScheduleRate">175%</div>
                        <div class="kpi-v2-meta">面談設定数 156/ 推薦数 89(39)</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="interviewHeldRate">
                        <div class="kpi-v2-label">面談実施率</div>
                        <div class="kpi-v2-value" id="companyInterviewHeldRate">85%</div>
                        <div class="kpi-v2-meta">面談実施数 132/面談設定数 156(28)</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="offerRate">
                        <div class="kpi-v2-label">内定率</div>
                        <div class="kpi-v2-value" id="companyOfferRate">52%</div>
                        <div class="kpi-v2-meta">内定数 68/ 面談実施数 132(15)</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="acceptRate">
                        <div class="kpi-v2-label">承諾率</div>
                        <div class="kpi-v2-value" id="companyAcceptRate">60%</div>
                        <div class="kpi-v2-meta">承諾数 41/ 内定数 68(9)</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 社員成績 -->
                <div class="kpi-v2-subsection">
                  <div class="kpi-v2-employee-header">
                    <h4 class="kpi-v2-subtitle">社員成績</h4>
                    <div class="kpi-v2-employee-controls">
                      <input type="text" id="employeeSearchInput" class="kpi-v2-search-input" placeholder="社員名で検索..." />
                      <select id="employeeSortSelect" class="kpi-v2-sort-select">
                        <option value="name-asc">社員名（昇順）</option>
                        <option value="proposals-desc">提案数（降順）</option>
                        <option value="offers-desc">内定数（降順）</option>
                        <option value="acceptRate-desc">承諾率（降順）</option>
                      </select>
                      <button id="employeeViewToggle" class="kpi-v2-view-toggle" data-view="table">
                        <span class="toggle-text">カード表示</span>
                      </button>
                    </div>
                  </div>

                  <!-- 表形式表示 -->
                  <div id="employeeTableView" class="kpi-v2-employee-table-wrapper">
                    <div class="kpi-v2-scroll-wrapper">
                      <table class="kpi-v2-employee-table">
                        <thead>
                          <tr>
                            <th>社員名</th>
                            <th>提案数</th>
                            <th>推薦数</th>
                            <th>面談設定数</th>
                            <th>面談実施数</th>
                            <th>内定数</th>
                            <th>承諾数</th>
                            <th>提案率</th>
                            <th>推薦率</th>
                            <th>面談設定率</th>
                            <th>面談実施率</th>
                            <th>内定率</th>
                            <th>承諾率</th>
                          </tr>
                        </thead>
                        <tbody id="employeeTableBody">
                          <!-- JavaScriptで生成 -->
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- カード形式表示 -->
                  <div id="employeeCardView" class="kpi-v2-employee-card-wrapper" style="display: none;">
                    <div class="kpi-v2-scroll-wrapper">
                      <div class="kpi-v2-employee-cards" id="employeeCardContainer">
                        <!-- JavaScriptで生成 -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <div class="section-shell space-y-4">
              <div class="flex items-center justify-between">
                <h3
                  class="text-lg font-semibold text-slate-800 whitespace-nowrap"
                >
                  4軸比較サマリー
                </h3>
                <div class="flex gap-2 text-sm">
                  <button
                    class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap"
                  >
                    媒体別
                  </button>
                  <button
                    class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap"
                  >
                    職種別
                  </button>
                  <button
                    class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap"
                  >
                    時期別
                  </button>
                  <button
                    class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap"
                  >
                    面接官別
                  </button>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-6">
                <div
                  class="h-56 bg-slate-100 rounded-xl border border-dashed border-slate-300 flex items-center justify-center text-slate-400 text-sm"
                >
                  レーダー / バブルチャート領域
                </div>
                <div
                  class="h-56 bg-slate-100 rounded-xl border border-dashed border-slate-300 flex items-center justify-center text-slate-400 text-sm"
                >
                  分布比較チャート領域
                </div>
              </div>
              <div
                class="h-48 bg-slate-100 rounded-xl border border-dashed border-slate-300 flex items-center justify-center text-slate-400 text-sm"
              >
                時系列トレンド（CV数・歩留・TAT）ラインチャート領域
              </div>
            </div>

            <div class="section-shell space-y-5">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                  <h3
                    class="text-lg font-semibold text-slate-800 whitespace-nowrap"
                  >
                    CA担当一覧（歩留トンネル）
                  </h3>
                  <p class="text-sm text-slate-500">
                    ボトルネックと滞留案件を即座に把握し、次アクションへ誘導
                  </p>
                </div>
                <div class="flex items-center gap-2 text-sm">
                  <label
                    for="roleSelect"
                    class="text-xs font-semibold text-slate-500 whitespace-nowrap"
                    >表示ロール</label
                  >
                  <select
                    id="roleSelect"
                    class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                  >
                    <option value="general">一般ユーザー</option>
                    <option value="manager">マネージャー</option>
                  </select>
                </div>
              </div>

              <div
                class="border border-slate-200 rounded-lg p-4 bg-slate-50 space-y-3"
              >
                <h4
                  class="text-sm font-semibold text-slate-700 whitespace-nowrap"
                >
                  絞り込み（AND）
                </h4>
                <div
                  class="grid grid-cols-1 xl:grid-cols-3 gap-4 text-xs text-slate-500"
                >
                  <label class="flex flex-col gap-1">
                    <span class="whitespace-nowrap"
                      >紹介する求職者名（部分一致）</span
                    >
                    <input
                      id="filterCandidateName"
                      type="search"
                      class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                      placeholder="候補者名で検索"
                    />
                  </label>
                  <label class="flex flex-col gap-1">
                    <span class="whitespace-nowrap">紹介先企業</span>
                    <select
                      id="filterCompany"
                      class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                    >
                      <option>すべて</option>
                      <option>ABC株式会社</option>
                      <option>XYZホールディングス</option>
                      <option>DEF株式会社</option>
                    </select>
                  </label>
                  <label class="flex flex-col gap-1">
                    <span class="whitespace-nowrap">担当社員</span>
                    <select
                      id="filterOwner"
                      class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                    >
                      <option>すべて</option>
                      <option>佐藤（CA）</option>
                      <option>田中（CA）</option>
                      <option>山本（CS）</option>
                    </select>
                  </label>
                  <div class="flex flex-col gap-1">
                    <span class="whitespace-nowrap">初回接点日時（範囲）</span>
                    <div class="flex items-center gap-2">
                      <input
                        id="filterInitialFrom"
                        type="date"
                        class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm flex-1"
                      />
                      <span class="text-slate-400">〜</span>
                      <input
                        id="filterInitialTo"
                        type="date"
                        class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm flex-1"
                      />
                    </div>
                  </div>
                  <div class="flex flex-col gap-2">
                    <span class="whitespace-nowrap"
                      >現在フェーズ（複数選択）</span
                    >
                    <div class="flex flex-wrap gap-3 text-xs text-slate-600">
                      <label
                        class="inline-flex items-center gap-1 whitespace-nowrap"
                      >
                        <input
                          type="checkbox"
                          class="phase-filter"
                          value="新規面談"
                          checked
                        />
                        新規面談
                      </label>
                      <label
                        class="inline-flex items-center gap-1 whitespace-nowrap"
                      >
                        <input
                          type="checkbox"
                          class="phase-filter"
                          value="面接前"
                          checked
                        />
                        面接前
                      </label>
                      <label
                        class="inline-flex items-center gap-1 whitespace-nowrap"
                      >
                        <input
                          type="checkbox"
                          class="phase-filter"
                          value="内定承諾待ち"
                        />
                        内定承諾待ち
                      </label>
                      <label
                        class="inline-flex items-center gap-1 whitespace-nowrap"
                      >
                        <input
                          type="checkbox"
                          class="phase-filter"
                          value="内定承諾"
                        />
                        内定承諾
                      </label>
                    </div>
                  </div>
                </div>
                <div
                  class="flex flex-wrap items-center justify-between gap-3 pt-2 border-t border-dashed border-slate-200"
                >
                  <div class="flex items-center gap-2 text-sm text-slate-500">
                    <label
                      for="sortKey"
                      class="text-xs font-semibold text-slate-500 whitespace-nowrap"
                      >並び替え</label
                    >
                    <select
                      id="sortKey"
                      class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                    >
                      <option value="phase">現在フェーズ（内定→新規）</option>
                      <option value="initial">初回接点日時</option>
                      <option value="stuck">滞留日数</option>
                    </select>
                    <button
                      id="sortDirection"
                      class="px-3 py-2 border border-slate-300 rounded-md text-sm font-medium hover:bg-slate-100 whitespace-nowrap"
                      data-order="desc"
                    >
                      降順
                    </button>
                  </div>
                  <div class="flex items-center gap-2">
                    <button
                      id="filterReset"
                      class="px-3 py-2 border border-slate-300 rounded-md text-sm hover:bg-slate-100 whitespace-nowrap"
                    >
                      条件をクリア
                    </button>
                    <button
                      id="filterApply"
                      class="px-3 py-2 bg-indigo-600 text-white rounded-md text-sm hover:bg-indigo-500 whitespace-nowrap"
                    >
                      フィルターを適用
                    </button>
                  </div>
                </div>
              </div>

              <div class="overflow-auto rounded-lg border border-slate-200">
                <table class="table-grid min-w-[1200px]">
                  <thead>
                    <tr>
                      <th>初回接点日時</th>
                      <th class="whitespace-nowrap">紹介する求職者名</th>
                      <th>紹介先企業</th>
                      <th>担当社員</th>
                      <th class="whitespace-nowrap">求職者の住所</th>
                      <th>電話番号</th>
                      <th>メールアドレス</th>
                      <th class="whitespace-nowrap">現在のフェーズ</th>
                      <th>フェーズ遷移タイムライン</th>
                    </tr>
                  </thead>
                  <tbody id="candidateTableBody">
                    <tr
                      class="candidate-row cursor-pointer hover:bg-indigo-50"
                      data-name="田中太郎"
                      data-company="ABC株式会社"
                      data-address="東京都港区南青山1-2-3"
                      data-phone-full="03-1234-5678"
                      data-phone-masked="***-****-5678"
                      data-email-full="tanaka.taro@example.com"
                      data-email-masked="tanaka***@example.com"
                      data-phase="内定承諾待ち"
                      data-owner="佐藤（CA）"
                      data-initial="2024-05-10"
                      data-initial-datetime="2024-05-10T14:20"
                      data-timeline="新規面談|2024/05/10;紹介可能|2024/05/12;企業に紹介|2024/05/13;面接前|2024/05/16;面接後|2024/05/22;内定獲得|2024/05/26;内定承諾待ち|2024/05/27"
                      data-stuck-days="4"
                      data-next-action="6/02 内定承諾フォロー（メール＋架電）"
                      data-memo="オファー条件の再確認待ち。kintoneコメント参照。"
                    >
                      <td>2024/05/10 14:20</td>
                      <td
                        class="text-indigo-700 font-semibold underline whitespace-nowrap"
                      >
                        田中太郎
                      </td>
                      <td>ABC株式会社</td>
                      <td>佐藤（CA）</td>
                      <td class="whitespace-nowrap">東京都港区南青山1-2-3</td>
                      <td>
                        <span
                          class="contact-field"
                          data-type="phone"
                          data-full="03-1234-5678"
                          data-masked="***-****-5678"
                          >***-****-5678</span
                        >
                      </td>
                      <td>
                        <span
                          class="contact-field"
                          data-type="email"
                          data-full="tanaka.taro@example.com"
                          data-masked="tanaka***@example.com"
                          >tanaka***@example.com</span
                        >
                      </td>
                      <td class="whitespace-nowrap">
                        <span class="inline-flex items-center gap-2">
                          <span
                            class="px-2 py-1 rounded-md text-xs font-semibold bg-amber-100 text-amber-700"
                            >内定承諾待ち</span
                          >
                        </span>
                      </td>
                      <td>
                        <div class="flex flex-wrap">
                          <span class="phase-chip active">新規面談 5/10</span>
                          <span class="phase-chip active">紹介可能 5/12</span>
                          <span class="phase-chip active">企業に紹介 5/13</span>
                          <span class="phase-chip active">面接前 5/16</span>
                          <span class="phase-chip active">面接後 5/22</span>
                          <span class="phase-chip active">内定獲得 5/26</span>
                          <span class="phase-chip active"
                            >内定承諾待ち 5/27</span
                          >
                          <span class="phase-chip pending">内定承諾 ー</span>
                        </div>
                      </td>
                    </tr>
                    <tr
                      class="candidate-row cursor-pointer hover:bg-indigo-50"
                      data-name="佐藤花子"
                      data-company="XYZホールディングス"
                      data-address="神奈川県川崎市中原区4-5-6"
                      data-phone-full="050-5566-7788"
                      data-phone-masked="050-****-7788"
                      data-email-full="sato.hanako@example.com"
                      data-email-masked="sato***@example.com"
                      data-phase="面接前"
                      data-owner="田中（CA）"
                      data-initial="2024-05-08"
                      data-initial-datetime="2024-05-08T10:05"
                      data-timeline="新規面談|2024/05/08;紹介可能|2024/05/09;企業に紹介|2024/05/10;面接前|2024/05/15"
                      data-stuck-days="7"
                      data-next-action="5/31 一次面接日程の企業リマインド"
                      data-memo="一次日程確定が遅延。面接官の調整待ち。"
                    >
                      <td>2024/05/08 10:05</td>
                      <td
                        class="text-indigo-700 font-semibold underline whitespace-nowrap"
                      >
                        佐藤花子
                      </td>
                      <td>XYZホールディングス</td>
                      <td>田中（CA）</td>
                      <td class="whitespace-nowrap">
                        神奈川県川崎市中原区4-5-6
                      </td>
                      <td>
                        <span
                          class="contact-field"
                          data-type="phone"
                          data-full="050-5566-7788"
                          data-masked="050-****-7788"
                          >050-****-7788</span
                        >
                      </td>
                      <td>
                        <span
                          class="contact-field"
                          data-type="email"
                          data-full="sato.hanako@example.com"
                          data-masked="sato***@example.com"
                          >sato***@example.com</span
                        >
                      </td>
                      <td class="whitespace-nowrap">
                        <span class="inline-flex items-center gap-2">
                          <span
                            class="px-2 py-1 rounded-md text-xs font-semibold bg-sky-100 text-sky-700"
                            >面接前</span
                          >
                          <span class="text-rose-600 text-xs font-semibold"
                            >滞留7日</span
                          >
                        </span>
                      </td>
                      <td>
                        <div class="flex flex-wrap">
                          <span class="phase-chip active">新規面談 5/08</span>
                          <span class="phase-chip active">紹介可能 5/09</span>
                          <span class="phase-chip active">企業に紹介 5/10</span>
                          <span class="phase-chip active">面接前 5/15</span>
                          <span class="phase-chip pending">面接後 ー</span>
                          <span class="phase-chip pending">内定獲得 ー</span>
                          <span class="phase-chip pending"
                            >内定承諾待ち ー</span
                          >
                          <span class="phase-chip pending">内定承諾 ー</span>
                        </div>
                      </td>
                    </tr>
                    <tr
                      class="candidate-row cursor-pointer hover:bg-indigo-50"
                      data-name="伊藤健"
                      data-company="DEF株式会社"
                      data-address="千葉県船橋市本町7-8-9"
                      data-phone-full="080-9999-1122"
                      data-phone-masked="080-****-1122"
                      data-email-full="ito.ken@example.com"
                      data-email-masked="ito***@example.com"
                      data-phase="内定承諾"
                      data-owner="山本（CS）"
                      data-initial="2024-04-28"
                      data-initial-datetime="2024-04-28T09:40"
                      data-timeline="新規面談|2024/04/28;紹介可能|2024/04/30;企業に紹介|2024/05/01;面接前|2024/05/04;面接後|2024/05/09;内定獲得|2024/05/12;内定承諾待ち|2024/05/13;内定承諾|2024/05/14"
                      data-stuck-days="0"
                      data-next-action="6/14 入社後30日ヒアリング"
                      data-memo="入社予定 6/01。書類は全て完了。"
                    >
                      <td>2024/04/28 09:40</td>
                      <td
                        class="text-indigo-700 font-semibold underline whitespace-nowrap"
                      >
                        伊藤健
                      </td>
                      <td>DEF株式会社</td>
                      <td>山本（CS）</td>
                      <td class="whitespace-nowrap">千葉県船橋市本町7-8-9</td>
                      <td>
                        <span
                          class="contact-field"
                          data-type="phone"
                          data-full="080-9999-1122"
                          data-masked="080-****-1122"
                          >080-****-1122</span
                        >
                      </td>
                      <td>
                        <span
                          class="contact-field"
                          data-type="email"
                          data-full="ito.ken@example.com"
                          data-masked="ito***@example.com"
                          >ito***@example.com</span
                        >
                      </td>
                      <td class="whitespace-nowrap">
                        <span class="inline-flex items-center gap-2">
                          <span
                            class="px-2 py-1 rounded-md text-xs font-semibold bg-emerald-100 text-emerald-700"
                            >内定承諾</span
                          >
                        </span>
                      </td>
                      <td>
                        <div class="flex flex-wrap">
                          <span class="phase-chip active">新規面談 4/28</span>
                          <span class="phase-chip active">紹介可能 4/30</span>
                          <span class="phase-chip active">企業に紹介 5/01</span>
                          <span class="phase-chip active">面接前 5/04</span>
                          <span class="phase-chip active">面接後 5/09</span>
                          <span class="phase-chip active">内定獲得 5/12</span>
                          <span class="phase-chip active"
                            >内定承諾待ち 5/13</span
                          >
                          <span class="phase-chip active">内定承諾 5/14</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>



          <section data-page="candidates" class="page-section space-y-6 hidden">
            <div class="section-shell space-y-5">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                  <h3 class="text-lg font-semibold text-slate-800 whitespace-nowrap">
                    候補者一覧
                  </h3>
                  <p class="text-sm text-slate-500">
                    応募者の詳細情報と架電管理を一元管理
                  </p>
                </div>
              </div>

              <div class="border border-slate-200 rounded-lg p-4 bg-slate-50 space-y-3">
                <h4 class="text-sm font-semibold text-slate-700 whitespace-nowrap">
                  絞り込み
                </h4>
                <div class="grid grid-cols-1 xl:grid-cols-4 gap-4 text-xs text-slate-500">
                  <label class="flex flex-col gap-1">
                    <span class="whitespace-nowrap">応募年月日（開始）</span>
                    <input
                      id="candidatesFilterDateFrom"
                      type="date"
                      class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                    />
                  </label>
                  <label class="flex flex-col gap-1">
                    <span class="whitespace-nowrap">応募年月日（終了）</span>
                    <input
                      id="candidatesFilterDateTo"
                      type="date"
                      class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                    />
                  </label>
                  <label class="flex flex-col gap-1">
                    <span class="whitespace-nowrap">応募媒体</span>
                    <select
                      id="candidatesFilterSource"
                      class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                    >
                      <option value="">すべて</option>
                      <option value="Indeed">Indeed</option>
                      <option value="求人ボックス">求人ボックス</option>
                      <option value="リクナビ">リクナビ</option>
                      <option value="マイナビ">マイナビ</option>
                    </select>
                  </label>
                  <label class="flex flex-col gap-1">
                    <span class="whitespace-nowrap">求職者名</span>
                    <input
                      id="candidatesFilterName"
                      type="search"
                      class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                      placeholder="候補者名で検索"
                    />
                  </label>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-4 gap-4 text-xs text-slate-500">
                  <label class="flex flex-col gap-1">
                    <span class="whitespace-nowrap">応募求人名</span>
                    <input
                      id="candidatesFilterJobTitle"
                      type="search"
                      class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm"
                      placeholder="求人名で検索"
                    />
                  </label>
                  <div class="flex items-end gap-2">
                    <button
                      id="candidatesFilterReset"
                      class="px-3 py-2 border border-slate-300 rounded-md text-sm hover:bg-slate-100 whitespace-nowrap"
                    >
                      条件をクリア
                    </button>
                    <div id="candidatesFilterCount" class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs font-semibold">
                      20件
                    </div>
                  </div>
                </div>
              </div>

              <div class="overflow-auto rounded-lg border border-slate-200">
                <table class="table-grid min-w-[1200px]">
                  <thead>
                    <tr>
                      <th class="cursor-pointer hover:bg-slate-100" data-sort="appliedAt">
                        応募日
                        <span class="ml-1 text-xs opacity-50">↕</span>
                      </th>
                      <th>応募されたサイト</th>
                      <th class="cursor-pointer hover:bg-slate-100" data-sort="name">
                        求職者名
                        <span class="ml-1 text-xs opacity-50">↕</span>
                      </th>
                      <th>電話番号</th>
                      <th>メールアドレス</th>
                      <th>応募求人名</th>
                      <th class="cursor-pointer hover:bg-slate-100" data-sort="companyName">
                        応募した企業名
                        <span class="ml-1 text-xs opacity-50">↕</span>
                      </th>
                      <th>住所</th>
                    </tr>
                  </thead>
                  <tbody id="candidatesTableBody">
                    <!-- JavaScriptで生成される候補者データ -->
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <section data-page="ad-spend" class="page-section space-y-6 hidden">
            <div class="card-grid">
              <div class="kpi-card">
                <strong>日次達成率</strong>
                <span>87%</span>
                <p class="text-xs text-slate-500 mt-1">目標 90%</p>
              </div>
              <div class="kpi-card">
                <strong>週次達成率</strong>
                <span>92%</span>
                <p class="text-xs text-slate-500 mt-1">トレンド +3pt</p>
              </div>
              <div class="kpi-card">
                <strong>月次達成率</strong>
                <span>79%</span>
                <p class="text-xs text-slate-500 mt-1">警告: 要対策</p>
              </div>
              <div class="kpi-card">
                <strong>返金額</strong>
                <span>¥280,000</span>
                <p class="text-xs text-slate-500 mt-1">閾値 20万円</p>
              </div>
            </div>

            <div class="section-shell space-y-4">
              <div class="flex items-center justify-between">
                <h3
                  class="text-lg font-semibold text-slate-800 whitespace-nowrap"
                >
                  媒体×CA/CS テーブル
                </h3>
                <div class="flex gap-2 text-sm">
                  <button
                    class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap"
                  >
                    列の表示管理
                  </button>
                  <button
                    class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap"
                  >
                    ピボット表示
                  </button>
                </div>
              </div>
              <div class="overflow-auto rounded-lg border border-slate-200">
                <table class="table-grid min-w-[1000px]">
                  <thead>
                    <tr>
                      <th class="fixed-col bg-indigo-50 whitespace-nowrap">
                        媒体
                      </th>
                      <th class="whitespace-nowrap">区分</th>
                      <th class="whitespace-nowrap">担当候補者数</th>
                      <th class="whitespace-nowrap">面談設定</th>
                      <th class="whitespace-nowrap">内定</th>
                      <th class="whitespace-nowrap">入社</th>
                      <th class="whitespace-nowrap">定着90</th>
                      <th class="whitespace-nowrap">返金額</th>
                      <th class="whitespace-nowrap">日次達成率</th>
                      <th class="whitespace-nowrap">週次達成率</th>
                      <th class="whitespace-nowrap">月次達成率</th>
                      <th class="whitespace-nowrap">備考</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="fixed-col font-medium">Indeed</td>
                      <td>CAチーム</td>
                      <td>58</td>
                      <td>41</td>
                      <td>12</td>
                      <td>10</td>
                      <td>89%</td>
                      <td>¥120,000</td>
                      <td>84%</td>
                      <td>90%</td>
                      <td>81%</td>
                      <td>CPA改善中</td>
                    </tr>
                    <tr>
                      <td class="fixed-col font-medium">Indeed</td>
                      <td>CSチーム</td>
                      <td>36</td>
                      <td>24</td>
                      <td>8</td>
                      <td>7</td>
                      <td>94%</td>
                      <td>¥40,000</td>
                      <td>91%</td>
                      <td>95%</td>
                      <td>88%</td>
                      <td>採用要件変更反映待ち</td>
                    </tr>
                    <tr>
                      <td class="fixed-col font-medium">求人ボックス</td>
                      <td>CAチーム</td>
                      <td>44</td>
                      <td>30</td>
                      <td>9</td>
                      <td>8</td>
                      <td>92%</td>
                      <td>¥80,000</td>
                      <td>88%</td>
                      <td>94%</td>
                      <td>76%</td>
                      <td>面談設定リードタイム改善</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="section-shell space-y-4">
              <div class="flex items-center justify-between">
                <h3
                  class="text-lg font-semibold text-slate-800 whitespace-nowrap"
                >
                  個票：パイプライン / 滞留 / 次アクション
                </h3>
                <div class="flex gap-2 text-sm">
                  <button
                    class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap"
                  >
                    通知設定
                  </button>
                  <button
                    class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap"
                  >
                    メモ履歴
                  </button>
                </div>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
                  <h4 class="text-sm font-semibold text-slate-700 mb-2">
                    パイプライン
                  </h4>
                  <ul class="space-y-2 text-sm text-slate-600">
                    <li>・一次待ち 12 件</li>
                    <li>・二次待ち 8 件</li>
                    <li>・内定フォロー中 5 件</li>
                    <li>・入社前手続き 3 件</li>
                  </ul>
                </div>
                <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
                  <h4 class="text-sm font-semibold text-slate-700 mb-2">
                    滞留警告
                  </h4>
                  <ul class="space-y-2 text-sm text-slate-600">
                    <li class="text-amber-600">
                      ・一次面談アサイン待ち（4日）: 高橋様
                    </li>
                    <li class="text-rose-600">
                      ・オファー提示から7日経過: 田中様
                    </li>
                    <li>・書類選考返答待ち: 3件</li>
                  </ul>
                </div>
                <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
                  <h4 class="text-sm font-semibold text-slate-700 mb-2">
                    次アクション期限
                  </h4>
                  <table class="table-grid">
                    <thead>
                      <tr>
                        <th>候補者</th>
                        <th>期限</th>
                        <th>担当</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>鈴木様</td>
                        <td class="text-rose-600 font-semibold">本日</td>
                        <td>佐藤</td>
                      </tr>
                      <tr>
                        <td>小林様</td>
                        <td>翌営業日</td>
                        <td>田中</td>
                      </tr>
                      <tr>
                        <td>伊藤様</td>
                        <td class="text-amber-600">+2日</td>
                        <td>山本</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <section data-page="tele-ops" class="page-section space-y-6 hidden">
            <div class="card-grid">
              <div class="kpi-card">
                <strong>30日チェック</strong>
                <span>88%</span>
                <p class="text-xs text-slate-500 mt-1">未完了 2件</p>
              </div>
              <div class="kpi-card">
                <strong>60日チェック</strong>
                <span>82%</span>
                <p class="text-xs text-slate-500 mt-1">要追跡 3件</p>
              </div>
              <div class="kpi-card">
                <strong>90日チェック</strong>
                <span>76%</span>
                <p class="text-xs text-slate-500 mt-1">警告: 滞留中</p>
              </div>
              <div class="kpi-card">
                <strong>返金総額</strong>
                <span>¥360,000</span>
                <p class="text-xs text-slate-500 mt-1">確定 4件</p>
              </div>
            </div>

            <div class="section-shell space-y-4">
              <h3
                class="text-lg font-semibold text-slate-800 whitespace-nowrap"
              >
                入社者チェック表
              </h3>
              <div class="overflow-auto rounded-lg border border-slate-200">
                <table class="table-grid min-w-[900px]">
                  <thead>
                    <tr>
                      <th class="fixed-col bg-indigo-50 whitespace-nowrap">
                        候補者
                      </th>
                      <th class="whitespace-nowrap">入社日</th>
                      <th class="whitespace-nowrap">30日</th>
                      <th class="whitespace-nowrap">60日</th>
                      <th class="whitespace-nowrap">90日</th>
                      <th class="whitespace-nowrap">コメント</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="fixed-col font-medium">田中太郎</td>
                      <td>2024/04/01</td>
                      <td><input type="checkbox" checked /></td>
                      <td><input type="checkbox" checked /></td>
                      <td><input type="checkbox" /></td>
                      <td>フォロー面談6/10予定</td>
                    </tr>
                    <tr>
                      <td class="fixed-col font-medium">佐藤花子</td>
                      <td>2024/04/15</td>
                      <td><input type="checkbox" checked /></td>
                      <td><input type="checkbox" /></td>
                      <td><input type="checkbox" /></td>
                      <td>60日連絡要</td>
                    </tr>
                    <tr>
                      <td class="fixed-col font-medium">伊藤健</td>
                      <td>2024/03/25</td>
                      <td><input type="checkbox" checked /></td>
                      <td><input type="checkbox" checked /></td>
                      <td><input type="checkbox" checked /></td>
                      <td></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="section-shell space-y-4">
              <div class="flex items-center justify-between">
                <h3
                  class="text-lg font-semibold text-slate-800 whitespace-nowrap"
                >
                  返金一覧（自動計算）
                </h3>
                <button
                  class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap"
                >
                  返金ルール設定
                </button>
              </div>
              <div class="overflow-auto rounded-lg border border-slate-200">
                <table class="table-grid min-w-[900px]">
                  <thead>
                    <tr>
                      <th class="fixed-col bg-indigo-50 whitespace-nowrap">
                        候補者
                      </th>
                      <th class="whitespace-nowrap">案件</th>
                      <th class="whitespace-nowrap">入社日</th>
                      <th class="whitespace-nowrap">辞退日</th>
                      <th class="whitespace-nowrap">返金率</th>
                      <th class="whitespace-nowrap">自動計算額</th>
                      <th class="whitespace-nowrap">確定</th>
                      <th class="whitespace-nowrap">備考</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="fixed-col font-medium">山田太郎</td>
                      <td>ABC社 CS</td>
                      <td>2024/02/01</td>
                      <td>2024/04/05</td>
                      <td>50%</td>
                      <td>¥180,000</td>
                      <td>
                        <button
                          class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded"
                        >
                          確定する
                        </button>
                      </td>
                      <td>規定どおり</td>
                    </tr>
                    <tr>
                      <td class="fixed-col font-medium">鈴木花子</td>
                      <td>XYZ社 営業</td>
                      <td>2024/01/20</td>
                      <td>2024/03/01</td>
                      <td>30%</td>
                      <td>¥120,000</td>
                      <td>
                        <button class="px-2 py-1 bg-slate-200 rounded">
                          確定済み
                        </button>
                      </td>
                      <td>担当者連絡済み</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="section-shell space-y-6">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <h3
                    class="text-lg font-semibold text-slate-800 mb-3 whitespace-nowrap"
                  >
                    辞退理由ヒートマップ
                  </h3>
                  <div
                    class="h-56 bg-slate-100 rounded-xl border border-dashed border-slate-300 flex items-center justify-center text-slate-400 text-sm"
                  >
                    理由×媒体/CA/案件のクロス集計ヒートマップ
                  </div>
                </div>
                <div>
                  <h3
                    class="text-lg font-semibold text-slate-800 mb-3 whitespace-nowrap"
                  >
                    Fee / 請求ステータス
                  </h3>
                  <div class="overflow-auto rounded-lg border border-slate-200">
                    <table class="table-grid min-w-[600px]">
                      <thead>
                        <tr>
                          <th class="whitespace-nowrap">案件</th>
                          <th class="whitespace-nowrap">想定金額</th>
                          <th class="whitespace-nowrap">確定金額</th>
                          <th class="whitespace-nowrap">請求書</th>
                          <th class="whitespace-nowrap">入金</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>ABC社 CS</td>
                          <td>¥600,000</td>
                          <td>¥580,000</td>
                          <td>確定済み</td>
                          <td class="text-emerald-600 font-medium">入金済み</td>
                        </tr>
                        <tr>
                          <td>XYZ社 営業</td>
                          <td>¥720,000</td>
                          <td>¥0</td>
                          <td class="text-amber-600 font-medium">
                            想定→確定待ち
                          </td>
                          <td>未入金</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div>
                <h3
                  class="text-lg font-semibold text-slate-800 mb-3 whitespace-nowrap"
                >
                  工程別TAT分析
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div
                    class="h-40 bg-slate-100 rounded-xl border border-dashed border-slate-300 flex items-center justify-center text-slate-400 text-sm"
                  >
                    箱ひげ図（TAT分布）
                  </div>
                  <div
                    class="h-40 bg-slate-100 rounded-xl border border-dashed border-slate-300 flex items-center justify-center text-slate-400 text-sm"
                  >
                    平均TATの推移
                  </div>
                  <div
                    class="h-40 bg-slate-100 rounded-xl border border-dashed border-slate-300 flex items-center justify-center text-slate-400 text-sm"
                  >
                    中央値TATの推移
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section
            data-page="ad-performance"
            class="page-section space-y-6 hidden"
          >
            <div class="section-shell space-y-4">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <h3
                  class="text-lg font-semibold text-slate-800 whitespace-nowrap"
                >
                  広告管理
                </h3>
                <div class="flex items-center gap-4">
                  <!-- 媒体名フィルタ -->
                  <div class="flex items-center gap-2">
                    <label for="adMediaFilter" class="text-sm text-slate-600 whitespace-nowrap">媒体名:</label>
                    <input
                      id="adMediaFilter"
                      type="text"
                      placeholder="媒体名で検索"
                      class="w-48 px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    />
                  </div>
                  <button
                    id="exportAdManagement"
                    class="px-3 py-2 border border-slate-300 rounded-md text-sm hover:bg-slate-100 whitespace-nowrap"
                  >
                    CSVエクスポート
                  </button>
                </div>
              </div>
              
              <!-- ページネーション上部 -->
              <div class="flex items-center justify-between text-sm text-slate-600">
                <div id="adManagementInfo" class="text-slate-500">0件中 0-0件表示</div>
                <div class="flex items-center gap-2">
                  <button id="adManagementPrevBtn" class="px-3 py-1 border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed" disabled>前へ</button>
                  <span id="adManagementPageInfo" class="px-2">1 / 1</span>
                  <button id="adManagementNextBtn" class="px-3 py-1 border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed" disabled>次へ</button>
                </div>
              </div>

              <div class="overflow-auto rounded-lg border border-slate-200">
                <table class="table-grid min-w-[1000px]">
                  <thead>
                    <tr>
                      <th class="fixed-col bg-indigo-50 whitespace-nowrap">媒体名</th>
                      <th class="sortable cursor-pointer hover:bg-slate-100 whitespace-nowrap" data-sort="applications">
                        応募者数 <span class="sort-indicator ml-1">↕</span>
                      </th>
                      <th class="whitespace-nowrap">面接設定</th>
                      <th class="whitespace-nowrap">内定</th>
                      <th class="sortable cursor-pointer hover:bg-slate-100 whitespace-nowrap" data-sort="hired">
                        入社 <span class="sort-indicator ml-1">↕</span>
                      </th>
                      <th class="sortable cursor-pointer hover:bg-slate-100 whitespace-nowrap" data-sort="retention">
                        定着率(30日) <span class="sort-indicator ml-1">↕</span>
                      </th>
                      <th class="sortable cursor-pointer hover:bg-slate-100 whitespace-nowrap" data-sort="refund">
                        返金額(税込) <span class="sort-indicator ml-1">↕</span>
                      </th>
                      <th class="whitespace-nowrap">有効応募者数</th>
                    </tr>
                  </thead>
                  <tbody id="adManagementTableBody">
                    <tr>
                      <td colspan="8" class="text-center text-slate-500 py-6">
                        読み込み中...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- ページネーション下部 -->
              <div class="flex items-center justify-between text-sm text-slate-600">
                <div class="text-slate-500">50件/ページ</div>
                <div class="flex items-center gap-2">
                  <button id="adManagementPrevBtn2" class="px-3 py-1 border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed" disabled>前へ</button>
                  <span id="adManagementPageInfo2" class="px-2">1 / 1</span>
                  <button id="adManagementNextBtn2" class="px-3 py-1 border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed" disabled>次へ</button>
                </div>
              </div>
            </div>
          </section>


          <section data-page="tele-log" class="page-section space-y-6 hidden">
            <!-- KPI v2: テレアポ管理 -->
            <section data-page="teleapo" data-kpi="v2" class="kpi-v2-wrapper space-y-6">
              <!-- 個人成績 -->
              <div class="kpi-v2-section">
                <div class="kpi-v2-header">
                  <h3 class="kpi-v2-title">個人成績</h3>
                  <div class="kpi-v2-range-picker">
                    <input type="date" id="teleapoPersonalRangeStart" class="kpi-v2-date-input" value="2024-11-01" />
                    <span class="kpi-v2-date-separator">〜</span>
                    <input type="date" id="teleapoPersonalRangeEnd" class="kpi-v2-date-input" value="2024-11-13" />
                  </div>
                </div>

                <!-- 4KPI 数の行 -->
                <div class="kpi-v2-scroll-wrapper">
                  <div class="kpi-v2-row" data-kpi-type="counts">
                    <div class="kpi-v2-card" data-kpi="dials">
                      <div class="kpi-v2-label">架電数</div>
                      <div class="kpi-v2-value" id="teleapoPersonalDials">156</div>
                      <div class="kpi-v2-meta">今期個人実績</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="connects">
                      <div class="kpi-v2-label">通電数</div>
                      <div class="kpi-v2-value" id="teleapoPersonalConnects">78</div>
                      <div class="kpi-v2-meta">今期個人実績</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="sets">
                      <div class="kpi-v2-label">設定数</div>
                      <div class="kpi-v2-value" id="teleapoPersonalSets">23</div>
                      <div class="kpi-v2-meta">今期個人実績</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="shows">
                      <div class="kpi-v2-label">着座数</div>
                      <div class="kpi-v2-value" id="teleapoPersonalShows">19</div>
                      <div class="kpi-v2-meta">今期個人実績</div>
                    </div>
                  </div>
                </div>

                <!-- 3KPI 率の行 -->
                <div class="kpi-v2-scroll-wrapper">
                  <div class="kpi-v2-row" data-kpi-type="rates">
                    <div class="kpi-v2-card" data-kpi="connectRate">
                      <div class="kpi-v2-label">通電率</div>
                      <div class="kpi-v2-value" id="teleapoPersonalConnectRate">50%</div>
                      <div class="kpi-v2-meta">通電数 78 / 架電数 156</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="setRate">
                      <div class="kpi-v2-label">設定率</div>
                      <div class="kpi-v2-value" id="teleapoPersonalSetRate">29%</div>
                      <div class="kpi-v2-meta">設定数 23 / 通電数 78</div>
                    </div>
                    <div class="kpi-v2-card" data-kpi="showRate">
                      <div class="kpi-v2-label">着座率</div>
                      <div class="kpi-v2-value" id="teleapoPersonalShowRate">83%</div>
                      <div class="kpi-v2-meta">着座数 19 / 設定数 23</div>
                    </div>
                  </div>
                </div>

                <!-- 折れ線グラフ: 期間内推移 -->
                <div class="kpi-v2-chart-section">
                  <h4 class="kpi-v2-chart-title">期間内推移</h4>
                  <div class="kpi-v2-chart-container">
                    <svg id="teleapoPersonalTrendChart" class="kpi-v2-svg-chart" viewBox="0 0 800 300">
                      <!-- チャートはJavaScriptで描画 -->
                    </svg>
                    <div class="kpi-v2-chart-legend" id="teleapoPersonalChartLegend">
                      <!-- 凡例はJavaScriptで生成 -->
                    </div>
                  </div>
                  <div class="kpi-v2-chart-tooltip" id="teleapoPersonalChartTooltip"></div>
                </div>
              </div>

              <!-- 社内成績 -->
              <div class="kpi-v2-section">
                <div class="kpi-v2-header">
                  <h3 class="kpi-v2-title">社内成績</h3>
                  <div class="kpi-v2-range-picker">
                    <input type="date" id="teleapoCompanyRangeStart" class="kpi-v2-date-input" value="2024-11-01" />
                    <span class="kpi-v2-date-separator">〜</span>
                    <input type="date" id="teleapoCompanyRangeEnd" class="kpi-v2-date-input" value="2024-11-13" />
                  </div>
                </div>

                <!-- 全体成績 -->
                <div class="kpi-v2-subsection">
                  <h4 class="kpi-v2-subtitle">全体成績</h4>
                  
                  <!-- 全体 4KPI 数の行 -->
                  <div class="kpi-v2-scroll-wrapper">
                    <div class="kpi-v2-row" data-kpi-type="counts">
                      <div class="kpi-v2-card" data-kpi="dials">
                        <div class="kpi-v2-label">架電数</div>
                        <div class="kpi-v2-value" id="teleapoCompanyDials">1,247</div>
                        <div class="kpi-v2-meta">全社員合計</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="connects">
                        <div class="kpi-v2-label">通電数</div>
                        <div class="kpi-v2-value" id="teleapoCompanyConnects">623</div>
                        <div class="kpi-v2-meta">全社員合計</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="sets">
                        <div class="kpi-v2-label">設定数</div>
                        <div class="kpi-v2-value" id="teleapoCompanySets">187</div>
                        <div class="kpi-v2-meta">全社員合計</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="shows">
                        <div class="kpi-v2-label">着座数</div>
                        <div class="kpi-v2-value" id="teleapoCompanyShows">154</div>
                        <div class="kpi-v2-meta">全社員合計</div>
                      </div>
                    </div>
                  </div>

                  <!-- 全体 3KPI 率の行 -->
                  <div class="kpi-v2-scroll-wrapper">
                    <div class="kpi-v2-row" data-kpi-type="rates">
                      <div class="kpi-v2-card" data-kpi="connectRate">
                        <div class="kpi-v2-label">通電率</div>
                        <div class="kpi-v2-value" id="teleapoCompanyConnectRate">50%</div>
                        <div class="kpi-v2-meta">通電数 623 / 架電数 1,247</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="setRate">
                        <div class="kpi-v2-label">設定率</div>
                        <div class="kpi-v2-value" id="teleapoCompanySetRate">30%</div>
                        <div class="kpi-v2-meta">設定数 187 / 通電数 623</div>
                      </div>
                      <div class="kpi-v2-card" data-kpi="showRate">
                        <div class="kpi-v2-label">着座率</div>
                        <div class="kpi-v2-value" id="teleapoCompanyShowRate">82%</div>
                        <div class="kpi-v2-meta">着座数 154 / 設定数 187</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 社員成績 -->
                <div class="kpi-v2-subsection">
                  <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold text-slate-800">社員成績</h4>
                    <div class="flex items-center gap-3">
                      <input type="text" id="teleapoEmployeeSearchInput" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" placeholder="社員名で検索..." />
                      <select id="teleapoEmployeeSortSelect" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm">
                        <option value="name-asc">社員名（昇順）</option>
                        <option value="dials-desc">架電数（降順）</option>
                        <option value="shows-desc">着座数（降順）</option>
                        <option value="connectRate-desc">通電率（降順）</option>
                      </select>
                    </div>
                  </div>

                  <!-- テーブル表示 -->
                  <div class="overflow-auto rounded-lg border border-slate-200">
                    <table class="table-grid min-w-[800px]">
                      <thead>
                        <tr>
                          <th class="whitespace-nowrap">社員名</th>
                          <th class="whitespace-nowrap">架電数</th>
                          <th class="whitespace-nowrap">通電数</th>
                          <th class="whitespace-nowrap">設定数</th>
                          <th class="whitespace-nowrap">着座数</th>
                          <th class="whitespace-nowrap">通電率</th>
                          <th class="whitespace-nowrap">設定率</th>
                          <th class="whitespace-nowrap">着座率</th>
                        </tr>
                      </thead>
                      <tbody id="teleapoEmployeeTableBody">
                        <!-- JavaScriptで生成 -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </section>

            <!-- 架電ログ -->
            <div class="section-shell space-y-4">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-slate-800 whitespace-nowrap">
                  架電ログ
                </h3>
                <div class="flex items-center gap-2">
                  <input type="date" id="teleapoLogRangeStart" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" value="2024-11-01" />
                  <span class="text-slate-500">〜</span>
                  <input type="date" id="teleapoLogRangeEnd" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" value="2024-11-13" />
                </div>
              </div>

              <!-- フィルタと検索 -->
              <div class="border border-slate-200 rounded-lg p-4 bg-slate-50 space-y-3">
                <h4 class="text-sm font-semibold text-slate-700">
                  絞り込み条件
                </h4>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 text-xs text-slate-500">
                  <div class="flex flex-col gap-1">
                    <label class="text-xs font-semibold text-slate-500">担当者</label>
                    <select id="teleapoLogEmployeeFilter" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm">
                      <option value="">全員</option>
                      <option value="佐藤">佐藤</option>
                      <option value="田中">田中</option>
                      <option value="山本">山本</option>
                      <option value="鈴木">鈴木</option>
                    </select>
                  </div>
                  <div class="flex flex-col gap-1">
                    <label class="text-xs font-semibold text-slate-500">アポ結果</label>
                    <select id="teleapoLogResultFilter" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm">
                      <option value="">全て</option>
                      <option value="通電">通電</option>
                      <option value="不在">不在</option>
                      <option value="設定">設定</option>
                      <option value="着座">着座</option>
                      <option value="コールバック">コールバック</option>
                    </select>
                  </div>
                  <div class="flex flex-col gap-1">
                    <label class="text-xs font-semibold text-slate-500">相手名検索</label>
                    <input type="text" id="teleapoLogTargetSearch" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" placeholder="相手名で検索..." />
                  </div>
                  <div class="flex items-end gap-2">
                    <button id="teleapoLogFilterReset" class="px-3 py-2 border border-slate-300 rounded-md text-sm hover:bg-slate-100 whitespace-nowrap">
                      条件をクリア
                    </button>
                    <div id="teleapoLogFilterCount" class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs font-semibold">
                      25件
                    </div>
                  </div>
                </div>
              </div>

              <!-- ログテーブル -->
              <div class="overflow-auto rounded-lg border border-slate-200">
                <table class="table-grid min-w-[1200px]" id="teleapoLogTable">
                  <thead>
                    <tr>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="datetime">
                        日時
                        <span class="ml-1 text-xs text-slate-400">▼</span>
                      </th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="employee">担当者</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="target">相手</th>
                      <th>電話番号</th>
                      <th>メールアドレス</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="result">アポ結果</th>
                      <th>メモ</th>
                    </tr>
                  </thead>
                  <tbody id="teleapoLogTableBody">
                    <tr>
                      <td class="whitespace-nowrap">2024/11/13 10:30</td>
                      <td>佐藤</td>
                      <td>ABC社 田中様</td>
                      <td>03-1234-5678</td>
                      <td>tanaka@abc-corp.co.jp</td>
                      <td>
                        <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs font-semibold">設定</span>
                      </td>
                      <td>一次面談→11/20 15:00設定</td>
                    </tr>
                    <tr>
                      <td class="whitespace-nowrap">2024/11/13 11:45</td>
                      <td>田中</td>
                      <td>XYZ社 鈴木様</td>
                      <td>03-9876-5432</td>
                      <td>suzuki@xyz-inc.co.jp</td>
                      <td>
                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-semibold">通電</span>
                      </td>
                      <td>一次日程打診中</td>
                    </tr>
                    <tr>
                      <td class="whitespace-nowrap">2024/11/13 13:20</td>
                      <td>山本</td>
                      <td>DEF社 佐々木様</td>
                      <td>03-5555-1111</td>
                      <td>sasaki@def-ltd.co.jp</td>
                      <td>
                        <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs font-semibold">不在</span>
                      </td>
                      <td>再架電予定 11/14</td>
                    </tr>
                    <tr>
                      <td class="whitespace-nowrap">2024/11/13 14:15</td>
                      <td>鈴木</td>
                      <td>GHI株式会社 高橋様</td>
                      <td>03-2222-9999</td>
                      <td>takahashi@ghi-group.com</td>
                      <td>
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-semibold">着座</span>
                      </td>
                      <td>面談完了、次回フォローアップ予定</td>
                    </tr>
                    <tr>
                      <td class="whitespace-nowrap">2024/11/13 15:30</td>
                      <td>佐藤</td>
                      <td>JKL商事 山田様</td>
                      <td>03-7777-3333</td>
                      <td>yamada@jkl-trading.jp</td>
                      <td>
                        <span class="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs font-semibold">コールバック</span>
                      </td>
                      <td>16:00に折り返し予定</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- ページネーション -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-sm text-slate-500">
                  <button class="px-3 py-2 border border-slate-300 rounded-md text-sm hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed" id="teleapoLogPrevBtn" disabled>前のページ</button>
                  <span class="px-3 py-2 text-sm" id="teleapoLogPageInfo">1 / 1</span>
                  <button class="px-3 py-2 border border-slate-300 rounded-md text-sm hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed" id="teleapoLogNextBtn" disabled>次のページ</button>
                </div>
                <div class="flex items-center gap-2 text-sm">
                  <label class="text-xs text-slate-500">表示件数</label>
                  <select class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" id="teleapoLogPageSize">
                    <option value="25">25件</option>
                    <option value="50" selected>50件</option>
                    <option value="100">100件</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- 分析: 週×時間帯ヒートマップ -->
            <div class="section-shell space-y-4">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-slate-800 whitespace-nowrap">
                  分析
                </h3>
                <div class="flex items-center gap-2">
                  <input type="date" id="teleapoAnalysisRangeStart" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" value="2024-11-01" />
                  <span class="text-slate-500">〜</span>
                  <input type="date" id="teleapoAnalysisRangeEnd" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" value="2024-11-13" />
                </div>
              </div>

              <!-- ヒートマップ: 曜日×時間の通電率 -->
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <h4 class="text-lg font-semibold text-slate-800">時間帯別通電率ヒートマップ</h4>
                  <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                      <label class="text-sm font-medium text-slate-600">社員フィルタ</label>
                      <select id="teleapoHeatmapEmployee" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm">
                        <option value="">全社員</option>
                        <option value="佐藤">佐藤</option>
                        <option value="田中">田中</option>
                        <option value="山本">山本</option>
                        <option value="鈴木">鈴木</option>
                      </select>
                    </div>
                    <div class="flex items-center gap-2">
                      <label class="text-sm font-medium text-slate-600">指標</label>
                      <select id="teleapoHeatmapMetric" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm">
                        <option value="connectRate" selected>通電率</option>
                        <option value="setRate">設定率</option>
                        <option value="showRate">着座率</option>
                        <option value="callCount">架電数</option>
                      </select>
                    </div>
                    <div class="flex items-center gap-2">
                      <label class="text-sm font-medium text-slate-600">並び替え</label>
                      <select id="teleapoHeatmapSort" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm">
                        <option value="week" selected>曜日順</option>
                        <option value="rate-desc">通電率（高→低）</option>
                        <option value="rate-asc">通電率（低→高）</option>
                      </select>
                    </div>
                  </div>
                </div>
                
                <div class="border border-slate-200 rounded-lg bg-white p-4" id="teleapoHeatmapContainer">
                  <!-- 時間軸ラベル -->
                  <div class="space-y-2">
                    <div class="grid grid-cols-[auto_repeat(10,1fr)] gap-1 mb-2">
                      <div class="text-xs text-slate-500 font-medium py-2"></div>
                      <div class="text-xs text-slate-500 font-medium text-center py-2">09</div>
                      <div class="text-xs text-slate-500 font-medium text-center py-2">10</div>
                      <div class="text-xs text-slate-500 font-medium text-center py-2">11</div>
                      <div class="text-xs text-slate-500 font-medium text-center py-2">12</div>
                      <div class="text-xs text-slate-500 font-medium text-center py-2">13</div>
                      <div class="text-xs text-slate-500 font-medium text-center py-2">14</div>
                      <div class="text-xs text-slate-500 font-medium text-center py-2">15</div>
                      <div class="text-xs text-slate-500 font-medium text-center py-2">16</div>
                      <div class="text-xs text-slate-500 font-medium text-center py-2">17</div>
                      <div class="text-xs text-slate-500 font-medium text-center py-2">18</div>
                    </div>
                    
                    <!-- ヒートマップデータ行 -->
                    <div id="teleapoHeatmapGrid" class="space-y-1">
                      <!-- 月曜日 -->
                      <div class="grid grid-cols-[auto_repeat(10,1fr)] gap-1">
                        <div class="text-xs font-medium text-slate-600 py-2 w-12">月</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.2);" data-rate="45" data-count="12" title="月曜日 09:00-10:00: 通電率45% (12/27)">45%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.6);" data-rate="65" data-count="18" title="月曜日 10:00-11:00: 通電率65% (18/28)">65%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.8);" data-rate="72" data-count="23" title="月曜日 11:00-12:00: 通電率72% (23/32)">72%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.3);" data-rate="38" data-count="8" title="月曜日 12:00-13:00: 通電率38% (8/21)">38%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.5);" data-rate="58" data-count="15" title="月曜日 13:00-14:00: 通電率58% (15/26)">58%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.9);" data-rate="78" data-count="21" title="月曜日 14:00-15:00: 通電率78% (21/27)">78%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.7);" data-rate="68" data-count="17" title="月曜日 15:00-16:00: 通電率68% (17/25)">68%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.4);" data-rate="52" data-count="13" title="月曜日 16:00-17:00: 通電率52% (13/25)">52%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.3);" data-rate="42" data-count="9" title="月曜日 17:00-18:00: 通電率42% (9/21)">42%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.1);" data-rate="28" data-count="4" title="月曜日 18:00-19:00: 通電率28% (4/14)">28%</div>
                      </div>
                      
                      <!-- 火曜日 -->
                      <div class="grid grid-cols-[auto_repeat(10,1fr)] gap-1">
                        <div class="text-xs font-medium text-slate-600 py-2 w-12">火</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.4);" data-rate="50" data-count="14" title="火曜日 09:00-10:00: 通電率50% (14/28)">50%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.7);" data-rate="70" data-count="21" title="火曜日 10:00-11:00: 通電率70% (21/30)">70%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.9);" data-rate="82" data-count="27" title="火曜日 11:00-12:00: 通電率82% (27/33)">82%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.2);" data-rate="35" data-count="7" title="火曜日 12:00-13:00: 通電率35% (7/20)">35%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.6);" data-rate="62" data-count="16" title="火曜日 13:00-14:00: 通電率62% (16/26)">62%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 1.0);" data-rate="85" data-count="23" title="火曜日 14:00-15:00: 通電率85% (23/27)">85%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.8);" data-rate="75" data-count="19" title="火曜日 15:00-16:00: 通電率75% (19/25)">75%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.5);" data-rate="55" data-count="14" title="火曜日 16:00-17:00: 通電率55% (14/25)">55%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.4);" data-rate="48" data-count="10" title="火曜日 17:00-18:00: 通電率48% (10/21)">48%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.2);" data-rate="32" data-count="5" title="火曜日 18:00-19:00: 通電率32% (5/16)">32%</div>
                      </div>

                      <!-- 水曜日〜日曜日も同様のパターンで続く -->
                      <div class="grid grid-cols-[auto_repeat(10,1fr)] gap-1">
                        <div class="text-xs font-medium text-slate-600 py-2 w-12">水</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.3);" data-rate="47" data-count="13">47%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.6);" data-rate="68" data-count="19">68%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.8);" data-rate="76" data-count="25">76%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.1);" data-rate="33" data-count="6">33%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.5);" data-rate="59" data-count="15">59%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.9);" data-rate="80" data-count="22">80%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.7);" data-rate="71" data-count="18">71%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.4);" data-rate="53" data-count="13">53%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.3);" data-rate="44" data-count="9">44%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.1);" data-rate="29" data-count="4">29%</div>
                      </div>

                      <div class="grid grid-cols-[auto_repeat(10,1fr)] gap-1">
                        <div class="text-xs font-medium text-slate-600 py-2 w-12">木</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.4);" data-rate="52" data-count="15">52%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.7);" data-rate="73" data-count="22">73%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 1.0);" data-rate="88" data-count="29">88%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.2);" data-rate="36" data-count="7">36%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.6);" data-rate="64" data-count="17">64%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.9);" data-rate="83" data-count="24">83%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.8);" data-rate="77" data-count="20">77%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.5);" data-rate="57" data-count="14">57%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.4);" data-rate="49" data-count="11">49%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.2);" data-rate="34" data-count="5">34%</div>
                      </div>

                      <div class="grid grid-cols-[auto_repeat(10,1fr)] gap-1">
                        <div class="text-xs font-medium text-slate-600 py-2 w-12">金</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.3);" data-rate="43" data-count="11">43%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.6);" data-rate="66" data-count="18">66%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.7);" data-rate="74" data-count="23">74%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.1);" data-rate="31" data-count="5">31%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.5);" data-rate="56" data-count="14">56%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.8);" data-rate="79" data-count="21">79%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.6);" data-rate="69" data-count="17">69%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.4);" data-rate="51" data-count="12">51%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.2);" data-rate="37" data-count="7">37%</div>
                        <div class="text-xs text-center py-2 px-1 rounded cursor-pointer hover:bg-slate-100" style="background-color: rgba(59, 130, 246, 0.1);" data-rate="25" data-count="3">25%</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 凡例 -->
                  <div class="mt-4 pt-4 border-t border-slate-200">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-4">
                        <div class="text-sm font-medium text-slate-700">通電率</div>
                        <div class="flex items-center gap-2">
                          <span class="text-xs text-slate-500">0%</span>
                          <div class="flex gap-1">
                            <div class="w-4 h-4 bg-slate-100 border border-slate-200 rounded"></div>
                            <div class="w-4 h-4 bg-blue-100 border border-slate-200 rounded"></div>
                            <div class="w-4 h-4 bg-blue-300 border border-slate-200 rounded"></div>
                            <div class="w-4 h-4 bg-blue-500 border border-slate-200 rounded"></div>
                            <div class="w-4 h-4 bg-blue-700 border border-slate-200 rounded"></div>
                          </div>
                          <span class="text-xs text-slate-500">100%</span>
                        </div>
                      </div>
                      <div class="text-xs text-slate-500">
                        ※ n&lt;5 の時間帯は薄表示、セルホバーで詳細表示
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- ヒートマップツールチップ -->
                <div class="hidden absolute z-50 bg-slate-800 text-white text-xs rounded px-2 py-1 pointer-events-none" id="teleapoHeatmapTooltip"></div>
              </div>
            </div>
            <!-- CTI CSV / 手入力取り込み -->
            <div class="section-shell space-y-4">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-slate-800 whitespace-nowrap">
                  CTI CSV / 手入力取り込み
                </h3>
                <button id="teleapoManualFormToggle" class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap">
                  手入力フォームを開く
                </button>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="border border-dashed border-indigo-300 rounded-xl p-6 bg-indigo-50">
                  <p class="text-sm font-semibold text-slate-700">
                    CSVアップロード（CTIエクスポート）
                  </p>
                  <p class="text-xs text-slate-500 mt-1">
                    日時・担当・通電結果・相手・電話番号・メールアドレス・メモをまとめて登録
                  </p>
                  <p class="text-xs text-slate-400 mt-2">
                    列構成: datetime, employee, target, phone, email, result, memo
                  </p>
                  <label class="mt-4 flex flex-col items-center justify-center gap-2 border border-indigo-200 border-dashed rounded-lg py-6 cursor-pointer hover:bg-indigo-100 transition">
                    <span class="text-sm font-medium text-indigo-600 whitespace-nowrap">CTI CSVファイルを選択</span>
                    <span class="text-xs text-slate-500">UTF-8 / 2MBまで</span>
                    <input type="file" id="teleapoCsvInput" accept=".csv" class="hidden" />
                  </label>
                  <div class="mt-3 text-xs text-slate-500">
                    <div class="font-semibold mb-1">取り込み後の処理:</div>
                    <ul class="list-disc list-inside space-y-1">
                      <li>CallLogモデルにマッピングして保存</li>
                      <li>個人・社内成績KPIを自動更新</li>
                      <li>架電ログテーブルに即座に反映</li>
                    </ul>
                  </div>
                </div>
                
                <div class="border border-slate-200 rounded-xl p-4 bg-slate-50">
                  <h4 class="text-sm font-semibold text-slate-700 mb-3">
                    手入力 (CallLog項目)
                  </h4>
                  <form id="teleapoManualForm" class="space-y-3 text-sm text-slate-600">
                    <div class="grid grid-cols-2 gap-3">
                      <label class="flex flex-col gap-1">
                        <span class="whitespace-nowrap">日時 <span class="text-rose-500">*</span></span>
                        <input type="datetime-local" id="teleapoManualDatetime" 
                               class="border border-slate-300 rounded-md px-3 py-2" required />
                      </label>
                      <label class="flex flex-col gap-1">
                        <span class="whitespace-nowrap">担当者 <span class="text-rose-500">*</span></span>
                        <select id="teleapoManualEmployee" class="border border-slate-300 rounded-md px-3 py-2" required>
                          <option value="">選択してください</option>
                          <option value="佐藤">佐藤</option>
                          <option value="田中">田中</option>
                          <option value="山本">山本</option>
                          <option value="鈴木">鈴木</option>
                        </select>
                      </label>
                    </div>
                    <label class="flex flex-col gap-1">
                      <span class="whitespace-nowrap">相手 <span class="text-rose-500">*</span></span>
                      <input type="text" id="teleapoManualTarget" 
                             class="border border-slate-300 rounded-md px-3 py-2"
                             placeholder="企業名・候補者名" required />
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                      <label class="flex flex-col gap-1">
                        <span class="whitespace-nowrap">電話番号</span>
                        <input type="tel" id="teleapoManualPhone"
                               class="border border-slate-300 rounded-md px-3 py-2"
                               placeholder="03-1234-5678" />
                      </label>
                      <label class="flex flex-col gap-1">
                        <span class="whitespace-nowrap">メールアドレス</span>
                        <input type="email" id="teleapoManualEmail"
                               class="border border-slate-300 rounded-md px-3 py-2"
                               placeholder="example@company.co.jp" />
                      </label>
                    </div>
                    <label class="flex flex-col gap-1">
                      <span class="whitespace-nowrap">アポ結果 <span class="text-rose-500">*</span></span>
                      <select id="teleapoManualResult" class="border border-slate-300 rounded-md px-3 py-2" required>
                        <option value="">選択してください</option>
                        <option value="通電">通電</option>
                        <option value="不在">不在</option>
                        <option value="設定">設定</option>
                        <option value="着座">着座</option>
                        <option value="コールバック">コールバック</option>
                      </select>
                    </label>
                    <label class="flex flex-col gap-1">
                      メモ
                      <textarea id="teleapoManualMemo" rows="3"
                                class="border border-slate-300 rounded-md px-3 py-2"
                                placeholder="応対内容・ヒアリング結果・次アクション等"></textarea>
                    </label>
                    <div class="flex gap-2 pt-2">
                      <button type="button" id="teleapoManualSave"
                              class="px-3 py-2 bg-indigo-600 text-white rounded-md whitespace-nowrap hover:bg-indigo-500">
                        CallLogに保存
                      </button>
                      <button type="button" id="teleapoManualReset"
                              class="px-3 py-2 border border-slate-300 rounded-md whitespace-nowrap hover:bg-slate-100">
                        リセット
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </section>

          <section data-page="referral" class="page-section space-y-6 hidden">
            <!-- 企業別実績テーブル -->
            <div class="section-shell space-y-4">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-slate-800 whitespace-nowrap">
                  企業別実績
                </h3>
                <div class="flex items-center gap-3">
                  <div class="flex items-center gap-2">
                    <input type="text" id="referralCompanyFilter" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" placeholder="企業名で検索..." />
                    <select id="referralSortSelect" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm">
                      <option value="company-asc">企業名（昇順）</option>
                      <option value="remaining-asc">残り人数（昇順）</option>
                      <option value="retention-desc">定着率（降順）</option>
                      <option value="hired-desc">入社数（降順）</option>
                    </select>
                  </div>
                  <button id="referralExportBtn" class="px-3 py-2 border border-slate-300 rounded-md text-sm hover:bg-slate-100 whitespace-nowrap">
                    CSVエクスポート
                  </button>
                </div>
              </div>

              <!-- フィルタ -->
              <div class="border border-slate-200 rounded-lg p-4 bg-slate-50 space-y-3">
                <h4 class="text-sm font-semibold text-slate-700">
                  絞り込み条件
                </h4>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 text-xs text-slate-500">
                  <div class="flex flex-col gap-1">
                    <label class="text-xs font-semibold text-slate-500">期間開始</label>
                    <input type="date" id="referralDateStart" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" value="2024-01-01" />
                  </div>
                  <div class="flex flex-col gap-1">
                    <label class="text-xs font-semibold text-slate-500">期間終了</label>
                    <input type="date" id="referralDateEnd" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" value="2024-12-31" />
                  </div>
                  <div class="flex flex-col gap-1">
                    <label class="text-xs font-semibold text-slate-500">職種</label>
                    <select id="referralJobFilter" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm">
                      <option value="">全て</option>
                      <option value="エンジニア">エンジニア</option>
                      <option value="営業">営業</option>
                      <option value="マネージャー">マネージャー</option>
                    </select>
                  </div>
                  <div class="flex items-end gap-2">
                    <button id="referralFilterReset" class="px-3 py-2 border border-slate-300 rounded-md text-sm hover:bg-slate-100 whitespace-nowrap">
                      条件をクリア
                    </button>
                    <div id="referralFilterCount" class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs font-semibold">
                      -件
                    </div>
                  </div>
                </div>
              </div>

              <!-- テーブル -->
              <div class="overflow-auto rounded-lg border border-slate-200">
                <table class="table-grid min-w-[1500px]" id="referralTable">
                  <thead>
                    <tr>
                      <th class="sticky left-0 bg-white z-10 cursor-pointer hover:bg-slate-100 sortable" data-sort="company">企業名</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="jobTitle">募集職種</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="planHeadcount">採用予定人数</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="remaining">残り人数</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="proposal">提案件数</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="docScreen">書類選考</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="interview1">一次面接</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="interview2">二次面接</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="offer">内定</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="joined">入社</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="retention">定着率</th>
                      <th class="cursor-pointer hover:bg-slate-100 sortable" data-sort="prejoinDeclines">入社前辞退数</th>
                    </tr>
                  </thead>
                  <tbody id="referralTableBody">
                    <!-- JavaScriptで生成 -->
                  </tbody>
                </table>
              </div>

              <!-- ページネーション -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-sm text-slate-500">
                  <button class="px-3 py-2 border border-slate-300 rounded-md text-sm hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed" id="referralPrevBtn" disabled>前のページ</button>
                  <span class="px-3 py-2 text-sm" id="referralPageInfo">1 / 1</span>
                  <button class="px-3 py-2 border border-slate-300 rounded-md text-sm hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed" id="referralNextBtn" disabled>次のページ</button>
                </div>
                <div class="flex items-center gap-2 text-sm">
                  <label class="text-xs text-slate-500">表示件数</label>
                  <select class="bg-white border border-slate-300 rounded-md px-3 py-2 text-sm" id="referralPageSize">
                    <option value="25">25件</option>
                    <option value="50" selected>50件</option>
                    <option value="100">100件</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- AIマッチング -->
            <div class="section-shell space-y-4">
              <h3 class="text-lg font-semibold text-slate-800 whitespace-nowrap">
                AIマッチング
              </h3>

              <!-- タブ切替 -->
              <div class="border-b border-slate-200">
                <nav class="-mb-px flex space-x-8">
                  <button class="py-2 px-1 border-b-2 border-indigo-500 text-indigo-600 text-sm font-medium" id="matchTabCandidate">
                    候補者を入力
                  </button>
                  <button class="py-2 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700 text-sm font-medium" id="matchTabCondition">
                    条件を入力
                  </button>
                </nav>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 候補者入力モード -->
                <div class="space-y-4" id="matchCandidatePanel">
                  <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
                    <h4 class="text-sm font-semibold text-slate-700 mb-3">
                      候補者プロフィール
                    </h4>
                    <textarea id="candidateText" rows="6" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm" placeholder="候補者のプロフィール、スキル、経験等を入力してください..."></textarea>
                    <div class="mt-3">
                      <button id="matchFromCandidate" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-500 text-sm font-medium">
                        マッチング実行
                      </button>
                    </div>
                  </div>
                </div>

                <!-- 条件入力モード -->
                <div class="space-y-4 hidden" id="matchConditionPanel">
                  <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
                    <h4 class="text-sm font-semibold text-slate-700 mb-3">
                      募集条件
                    </h4>
                    <div class="space-y-3">
                      <div class="grid grid-cols-2 gap-3">
                        <label class="flex flex-col gap-1">
                          <span class="text-xs font-semibold text-slate-600">年収下限（万円）</span>
                          <input type="number" id="conditionSalaryMin" class="border border-slate-300 rounded-md px-3 py-2 text-sm" placeholder="400" />
                        </label>
                        <label class="flex flex-col gap-1">
                          <span class="text-xs font-semibold text-slate-600">年収上限（万円）</span>
                          <input type="number" id="conditionSalaryMax" class="border border-slate-300 rounded-md px-3 py-2 text-sm" placeholder="800" />
                        </label>
                      </div>
                      <label class="flex flex-col gap-1">
                        <span class="text-xs font-semibold text-slate-600">勤務地</span>
                        <input type="text" id="conditionLocation" class="border border-slate-300 rounded-md px-3 py-2 text-sm" placeholder="東京都内、リモート可" />
                      </label>
                      <label class="flex flex-col gap-1">
                        <span class="text-xs font-semibold text-slate-600">必要スキル・経験</span>
                        <textarea id="conditionSkills" rows="3" class="border border-slate-300 rounded-md px-3 py-2 text-sm" placeholder="React, Node.js, 3年以上のエンジニア経験..."></textarea>
                      </label>
                      <div class="mt-3">
                        <button id="matchFromCondition" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-500 text-sm font-medium">
                          マッチング実行
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- マッチング結果 -->
                <div class="space-y-4">
                  <div class="border border-slate-200 rounded-lg p-4 bg-white">
                    <div class="flex items-center justify-between mb-3">
                      <h4 class="text-sm font-semibold text-slate-700">
                        マッチング結果
                      </h4>
                      <select id="matchResultSort" class="bg-white border border-slate-300 rounded-md px-3 py-2 text-xs">
                        <option value="score-desc">スコア（降順）</option>
                        <option value="company-asc">企業名（昇順）</option>
                      </select>
                    </div>
                    <div id="matchResults" class="space-y-3 min-h-[200px]">
                      <div class="text-center text-slate-500 text-sm py-8">
                        マッチング実行でここに結果が表示されます
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </main>
      </div>
    </div>

    <!-- 企業詳細ドロワー -->
    <div id="companyDrawerOverlay" class="drawer-overlay hidden"></div>
    <aside id="companyDrawer" class="detail-drawer hidden">
      <div class="drawer-header">
        <div>
          <h3 id="companyDrawerName" class="text-xl font-semibold text-slate-900">
            企業名
          </h3>
          <p class="text-sm text-slate-500 mt-1">
            <span id="companyDrawerLocation">所在地</span>
          </p>
        </div>
        <button id="companyDrawerClose" class="close-button">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="drawer-content">
        <!-- 企業情報 -->
        <div class="drawer-section">
          <h4 class="drawer-section-title">企業情報</h4>
          <div class="info-grid">
            <div class="info-item">
              <dt class="info-label">会社名</dt>
              <dd id="companyInfo_name" class="info-value">-</dd>
            </div>
            <div class="info-item">
              <dt class="info-label">所在地</dt>
              <dd id="companyInfo_address" class="info-value">-</dd>
            </div>
            <div class="info-item">
              <dt class="info-label">担当者</dt>
              <dd id="companyInfo_contact" class="info-value">-</dd>
            </div>
            <div class="info-item">
              <dt class="info-label">業界</dt>
              <dd id="companyInfo_industry" class="info-value">-</dd>
            </div>
            <div class="info-item" style="grid-column: 1 / -1;">
              <dt class="info-label">概要</dt>
              <dd id="companyInfo_profile" class="info-value">-</dd>
            </div>
          </div>
        </div>

        <!-- 指標サマリー -->
        <div class="drawer-section">
          <h4 class="drawer-section-title">指標サマリー</h4>
          <div class="summary-grid">
            <div class="summary-item">
              <div id="summary_proposal" class="summary-value">-</div>
              <div class="summary-label">提案件数</div>
            </div>
            <div class="summary-item">
              <div id="summary_hired" class="summary-value">-</div>
              <div class="summary-label">入社数</div>
            </div>
            <div class="summary-item">
              <div id="summary_retention" class="summary-value">-</div>
              <div class="summary-label">定着率</div>
            </div>
            <div class="summary-item">
              <div id="summary_fee" class="summary-value">-</div>
              <div class="summary-label">Fee</div>
            </div>
            <div class="summary-item">
              <div id="summary_leadtime" class="summary-value">-</div>
              <div class="summary-label">平均リードタイム</div>
            </div>
            <div class="summary-item">
              <div id="summary_prejoinDeclines" class="summary-value">-</div>
              <div class="summary-label">入社前辞退数</div>
            </div>
          </div>
        </div>

        <!-- 欲しい人材 -->
        <div class="drawer-section">
          <h4 class="drawer-section-title">欲しい人材</h4>
          <div class="info-grid">
            <div class="info-item">
              <dt class="info-label">必要資格・スキル</dt>
              <dd id="wants_skills" class="info-value">-</dd>
            </div>
            <div class="info-item">
              <dt class="info-label">経験要件</dt>
              <dd id="wants_experience" class="info-value">-</dd>
            </div>
            <div class="info-item">
              <dt class="info-label">求める人物像</dt>
              <dd id="wants_traits" class="info-value">-</dd>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- テレアポ管理用のドロワー・モーダル（将来拡張用） -->

    <div id="drawerOverlay" class="drawer-overlay"></div>
    <aside id="candidateDrawer" class="detail-drawer">
      <div
        class="px-6 py-5 border-b border-slate-200 flex items-start justify-between"
      >
        <div>
          <h3 id="drawerName" class="text-xl font-semibold text-slate-900">
            候補者名
          </h3>
          <p class="text-sm text-slate-500 mt-1">
            <span id="drawerCompany">企業名</span> / 担当:
            <span id="drawerOwner">担当者</span>
          </p>
          <div class="mt-3 flex flex-wrap gap-2 text-xs text-slate-600">
            <span
              class="px-2 py-1 rounded-md bg-indigo-100 text-indigo-700 font-semibold"
              id="drawerPhase"
              >フェーズ</span
            >
            <span
              class="px-2 py-1 rounded-md bg-slate-100 text-slate-700"
              id="drawerInitial"
              >初回接点 -</span
            >
            <span
              class="px-2 py-1 rounded-md bg-rose-50 text-rose-600 font-semibold"
              id="drawerStuck"
              >滞留0日</span
            >
          </div>
        </div>
        <button
          id="drawerClose"
          class="text-slate-400 hover:text-slate-600 transition"
          aria-label="閉じる"
        >
          ✕
        </button>
      </div>
      <div class="flex-1 overflow-y-auto px-6 py-5 space-y-6">
        <section class="space-y-2">
          <h4 class="text-sm font-semibold text-slate-700">連絡先</h4>
          <dl class="grid grid-cols-1 gap-3 text-sm text-slate-600">
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">
                住所
              </dt>
              <dd id="drawerAddress">-</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">
                電話
              </dt>
              <dd id="drawerPhone">-</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-400">
                メール
              </dt>
              <dd id="drawerEmail">-</dd>
            </div>
          </dl>
          <p class="text-xs text-slate-400">
            ※編集はkintone側で行います。ロールによってマスク制御されます。
          </p>
        </section>
        <section class="space-y-3">
          <div class="flex items-center justify-between">
            <h4 class="text-sm font-semibold text-slate-700">
              進捗タイムライン
            </h4>
            <span class="text-xs text-slate-400"
              >フェーズ順: 新規面談 → 内定承諾</span
            >
          </div>
          <div id="drawerTimeline" class="space-y-4"></div>
        </section>
        <section class="space-y-2">
          <h4 class="text-sm font-semibold text-slate-700">次アクション</h4>
          <div
            id="drawerNextAction"
            class="text-sm text-slate-600 bg-amber-50 border border-amber-100 rounded-lg px-4 py-3"
          >
            -
          </div>
        </section>
        <section class="space-y-2">
          <h4 class="text-sm font-semibold text-slate-700">メモ</h4>
          <div
            id="drawerMemo"
            class="text-sm text-slate-600 bg-slate-50 border border-slate-200 rounded-lg px-4 py-3"
          >
            -
          </div>
        </section>
      </div>
      <div class="px-6 py-4 border-t border-slate-200 text-xs text-slate-500">
        更に詳細が必要な場合は「個票を開く」をクリックし、kintoneのレコードを参照してください。
      </div>
    </aside>

    <script>
      const sections = document.querySelectorAll(".page-section");
      const navLinks = document.querySelectorAll(".nav-link");
      const title = document.getElementById("pageTitle");
      const subtitle = document.getElementById("pageSubtitle");

      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");
      if (sidebar && sidebarToggle) {
        const updateSidebarToggleLabel = () => {
          sidebarToggle.textContent = sidebar.classList.contains(
            "sidebar-collapsed"
          )
            ? "⪢"
            : "⪡";
        };
        sidebarToggle.addEventListener("click", () => {
          sidebar.classList.toggle("sidebar-collapsed");
          updateSidebarToggleLabel();
        });
        updateSidebarToggleLabel();
      }

      const pageMeta = {
        yield: {
          title: "歩留管理（総合）",
          subtitle:
            "歩留KPIとCA担当一覧をスプレッドシート形式で可視化し滞留を把握",
        },
        "ad-spend": {
          title: "広告費管理",
          subtitle:
            "媒体×CA/CSの成果を日/週/月単位で把握し、滞留や次アクションを管理",
        },
        introduction: {
          title: "各企業の紹介実績管理",
          subtitle:
            "クライアント／案件別のステージ進捗と候補者タイムラインを整理",
        },
        "tele-ops": {
          title: "テレアポ実績管理",
          subtitle:
            "入社後フォロー・返金・辞退理由を表形式でトラッキングし、TATを分析",
        },
        "ad-performance": {
          title: "広告管理",
          subtitle:
            "媒体・求人別の主要指標と突合状況をモニタリングし、CSV取込を実行",
        },
        "tele-log": {
          title: "テレアポ管理",
          subtitle: "架電ログと指標カードを一元管理し、CSV取込や手入力で更新",
        },
      };

      navLinks.forEach((link) => {
        link.addEventListener("click", () => {
          const target = link.dataset.target;

          sections.forEach((section) => {
            if (section.dataset.page === target) {
              section.classList.remove("hidden");
            } else {
              section.classList.add("hidden");
            }
          });

          navLinks.forEach((btn) => {
            btn.classList.remove("bg-slate-800", "text-white");
          });
          link.classList.add("bg-slate-800", "text-white");

          if (pageMeta[target]) {
            title.textContent = pageMeta[target].title;
            subtitle.textContent = pageMeta[target].subtitle;
          }
        });
      });

      const jobCatalog = [
        {
          id: "JOB-001",
          title: "フロントエンドエンジニア",
          department: "開発",
        },
        { id: "JOB-002", title: "カスタマーサクセス", department: "CS" },
        { id: "JOB-003", title: "インサイドセールス", department: "営業" },
        {
          id: "JOB-004",
          title: "バックオフィススペシャリスト",
          department: "管理",
        },
      ];
      const jobMap = jobCatalog.reduce((acc, job) => {
        acc[job.id] = job;
        return acc;
      }, {});

      const currencyRates = {
        JPY: 1,
        USD: 140,
      };

      const currencyFormatters = {
        JPY: new Intl.NumberFormat("ja-JP", {
          style: "currency",
          currency: "JPY",
          maximumFractionDigits: 0,
        }),
        USD: new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }),
      };

      const percentFormatter = new Intl.NumberFormat("ja-JP", {
        minimumFractionDigits: 0,
        maximumFractionDigits: 1,
      });
      const numberFormatter = new Intl.NumberFormat("ja-JP");

      const adState = {
        records: [],
        unmatched: [],
        importLog: [],
        filters: {
          from: null,
          to: null,
          media: "all",
          job: "all",
          department: "all",
          granularity: "monthly",
        },
        currency: "JPY",
        selectedJobDetail: "auto",
        latestFilteredRecords: [],
        latestMediaSummary: [],
      };

      const sampleAdRecords = [
        {
          media: "Indeed",
          job_id: "JOB-001",
          period_start: "2024-04-01",
          period_end: "2024-04-30",
          impressions: 85000,
          clicks: 3300,
          applications: 200,
          introductions: 110,
          hires: 9,
          cost: 210000,
          currency: "JPY",
        },
        {
          media: "Indeed",
          job_id: "JOB-001",
          period_start: "2024-05-01",
          period_end: "2024-05-31",
          impressions: 120000,
          clicks: 5500,
          applications: 420,
          introductions: 210,
          hires: 18,
          cost: 270000,
          currency: "JPY",
        },
        {
          media: "求人ボックス",
          job_id: "JOB-002",
          period_start: "2024-04-01",
          period_end: "2024-04-30",
          impressions: 42000,
          clicks: 1600,
          applications: 115,
          introductions: 60,
          hires: 5,
          cost: 95000,
          currency: "JPY",
        },
        {
          media: "求人ボックス",
          job_id: "JOB-002",
          period_start: "2024-05-01",
          period_end: "2024-05-31",
          impressions: 52000,
          clicks: 1980,
          applications: 156,
          introductions: 84,
          hires: 7,
          cost: 118000,
          currency: "JPY",
        },
        {
          media: "エンポケ",
          job_id: "JOB-003",
          period_start: "2024-04-01",
          period_end: "2024-04-30",
          impressions: 18000,
          clicks: 720,
          applications: 65,
          introductions: 30,
          hires: 3,
          cost: 60000,
          currency: "JPY",
        },
        {
          media: "Indeed",
          job_id: "JOB-003",
          period_start: "2024-05-01",
          period_end: "2024-05-31",
          impressions: 64000,
          clicks: 2400,
          applications: 150,
          introductions: 70,
          hires: 6,
          cost: 1200,
          currency: "USD",
        },
        {
          media: "エンポケ",
          job_id: "JOB-004",
          period_start: "2024-05-01",
          period_end: "2024-05-31",
          impressions: 15000,
          clicks: 640,
          applications: 58,
          introductions: 26,
          hires: 2,
          cost: 72000,
          currency: "JPY",
        },
        {
          media: "エンポケ",
          job_id: "JOB-999",
          period_start: "2024-05-01",
          period_end: "2024-05-31",
          impressions: 12000,
          clicks: 520,
          applications: 80,
          introductions: 40,
          hires: 4,
          cost: 90000,
          currency: "JPY",
        },
      ];

      const currencySelect = document.getElementById("currencySelect");
      const adFilterFromInput = document.getElementById("adFilterFrom");
      const adFilterToInput = document.getElementById("adFilterTo");
      const adFilterMediaSelect = document.getElementById("adFilterMedia");
      const adFilterJobSelect = document.getElementById("adFilterJob");
      const adFilterDepartmentSelect =
        document.getElementById("adFilterDepartment");
      const adFilterGranularitySelect = document.getElementById(
        "adFilterGranularity"
      );
      const adFilterApplyBtn = document.getElementById("adFilterApply");
      const adFilterResetBtn = document.getElementById("adFilterReset");
      const exportMediaSummaryBtn =
        document.getElementById("exportMediaSummary");
      const downloadCsvTemplateBtn = document.getElementById(
        "downloadCsvTemplate"
      );
      const loadSampleDataBtn = document.getElementById("loadSampleData");
      const adCsvInput = document.getElementById("adCsvInput");
      const resolveUnmatchedBtn = document.getElementById("resolveUnmatched");
      const clearUnmatchedSelectionsBtn = document.getElementById(
        "clearUnmatchedSelections"
      );

      const kpiTotalCostEl = document.getElementById("kpiTotalCost");
      const kpiTotalCostNoteEl = document.getElementById("kpiTotalCostNote");
      const kpiTotalApplicationsEl = document.getElementById(
        "kpiTotalApplications"
      );
      const kpiTotalApplicationsNoteEl = document.getElementById(
        "kpiTotalApplicationsNote"
      );
      const kpiCostApplyEl = document.getElementById("kpiCostApply");
      const kpiCostHireEl = document.getElementById("kpiCostHire");

      const mediaSummaryTableBody = document.getElementById(
        "mediaSummaryTableBody"
      );
      const jobDetailSelect = document.getElementById("jobDetailSelect");
      const jobDetailChart = document.getElementById("jobDetailChart");
      const jobDetailSummary = document.getElementById("jobDetailSummary");
      const jobDetailTableBody = document.getElementById("jobDetailTableBody");

      const unmatchedEmptyState = document.getElementById(
        "unmatchedEmptyState"
      );
      const unmatchedTableWrapper = document.getElementById(
        "unmatchedTableWrapper"
      );
      const unmatchedTableBody = document.getElementById("unmatchedTableBody");
      const importLogBody = document.getElementById("importLogBody");

      const convertBaseToCurrency = (baseValue, currency) => {
        if (!currencyRates[currency]) return null;
        return baseValue / currencyRates[currency];
      };

      const formatSelectedCurrency = (baseValue) => {
        if (baseValue === null || baseValue === undefined) return "—";
        const formatter = currencyFormatters[adState.currency];
        if (!formatter) return "—";
        const converted = convertBaseToCurrency(baseValue, adState.currency);
        if (!Number.isFinite(converted)) return "—";
        return formatter.format(converted);
      };

      const formatCostPer = (baseCost, denominator) => {
        if (!denominator) return "—";
        const perUnitBase = baseCost / denominator;
        if (!Number.isFinite(perUnitBase)) return "—";
        return formatSelectedCurrency(perUnitBase);
      };

      const formatPercent = (value) => {
        if (!Number.isFinite(value)) return "—";
        return `${percentFormatter.format(value)}%`;
      };

      const formatNumber = (value) => {
        if (value === null || value === undefined) return "—";
        return numberFormatter.format(value);
      };

      const getJobInfo = (jobId) => jobMap[jobId] || null;
      const getJobDisplayName = (jobId) => {
        const info = getJobInfo(jobId);
        return info ? `${info.title}（${info.department}）` : jobId;
      };

      const normalizeEndDate = (date) =>
        new Date(
          date.getFullYear(),
          date.getMonth(),
          date.getDate(),
          23,
          59,
          59,
          999
        );

      const formatDateRange = (startDate, endDate) => {
        if (!startDate || !endDate) return "-";
        const start = `${startDate.getFullYear()}/${String(
          startDate.getMonth() + 1
        ).padStart(2, "0")}/${String(startDate.getDate()).padStart(2, "0")}`;
        const end = `${endDate.getFullYear()}/${String(
          endDate.getMonth() + 1
        ).padStart(2, "0")}/${String(endDate.getDate()).padStart(2, "0")}`;
        return `${start}〜${end}`;
      };

      const formatPeriodLabel = (date, granularity) => {
        if (!date) return "-";
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        if (granularity === "daily") return `${year}/${month}/${day}`;
        if (granularity === "weekly") {
          const week = Math.ceil(date.getDate() / 7);
          return `${year}/${month} W${week}`;
        }
        return `${year}/${month}`;
      };

      const getPeriodKey = (date, granularity) => {
        if (!date) return "";
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        if (granularity === "daily") return `${y}-${m}-${d}`;
        if (granularity === "weekly") {
          const week = Math.ceil(date.getDate() / 7);
          return `${y}-${m}-W${week}`;
        }
        return `${y}-${m}`;
      };

      const buildRecordFromRaw = (raw, rowIndex, sourceLabel) => {
        const errors = [];
        const media = (raw.media || "").trim();
        const jobIdRaw = (raw.job_id || "").trim();
        const periodStart = parseDateValue(raw.period_start);
        const periodEnd = parseDateValue(raw.period_end);

        if (!media) errors.push("media が空です");
        if (!jobIdRaw) errors.push("job_id が空です");
        if (!periodStart || !periodEnd) errors.push("期間が不正です");

        const numericFields = [
          "impressions",
          "clicks",
          "applications",
          "introductions",
          "hires",
        ];
        const parsedNumbers = {};
        numericFields.forEach((field) => {
          const value = raw[field];
          const parsedValue =
            value === "" || value === null || value === undefined
              ? 0
              : Number(value);
          if (!Number.isFinite(parsedValue) || parsedValue < 0) {
            errors.push(`${field} が不正です`);
          } else {
            parsedNumbers[field] = parsedValue;
          }
        });

        const costValue =
          raw.cost === "" || raw.cost === null || raw.cost === undefined
            ? 0
            : Number(raw.cost);
        if (!Number.isFinite(costValue) || costValue < 0) {
          errors.push("cost が不正です");
        }

        const currency = (raw.currency || "").trim().toUpperCase();
        if (!currencyRates[currency]) {
          errors.push(`currency (${currency || "-"}) が未対応です`);
        }

        if (
          parsedNumbers.impressions < parsedNumbers.clicks ||
          parsedNumbers.clicks < parsedNumbers.applications
        ) {
          errors.push(
            "impressions >= clicks >= applications の条件を満たしていません"
          );
        }
        if (parsedNumbers.introductions > parsedNumbers.applications) {
          errors.push("introductions は applications 以下である必要があります");
        }
        if (parsedNumbers.hires > parsedNumbers.introductions) {
          errors.push("hires は introductions 以下である必要があります");
        }

        if (errors.length) {
          return { ok: false, errors };
        }

        const baseCost = costValue * currencyRates[currency];
        return {
          ok: true,
          record: {
            media,
            jobId: jobIdRaw,
            periodStart,
            periodEnd,
            impressions: parsedNumbers.impressions,
            clicks: parsedNumbers.clicks,
            applications: parsedNumbers.applications,
            introductions: parsedNumbers.introductions,
            hires: parsedNumbers.hires,
            cost: costValue,
            currency,
            baseCost,
            sourceRow: rowIndex,
            source: sourceLabel,
          },
        };
      };

      const ingestRecords = (rawRecords, options = {}) => {
        const {
          mode = "append",
          fileName = "CSV",
          sourceLabel = fileName,
        } = options;
        if (!Array.isArray(rawRecords) || rawRecords.length === 0) {
          return {
            total: 0,
            success: 0,
            unmatched: 0,
            errors: ["レコードがありません"],
            fileName,
            timestamp: new Date(),
          };
        }

        if (mode === "replace") {
          adState.records = [];
          adState.unmatched = [];
        }

        const addedRecords = [];
        const newlyUnmatched = [];
        const errorMessages = [];

        rawRecords.forEach((raw, index) => {
          const result = buildRecordFromRaw(raw, index + 1, sourceLabel);
          if (!result.ok) {
            result.errors.forEach((err) =>
              errorMessages.push(`Row ${index + 1}: ${err}`)
            );
            return;
          }

          const normalized = result.record;
          const jobInfo = getJobInfo(normalized.jobId);
          if (!jobInfo) {
            newlyUnmatched.push({
              id: `${Date.now()}-${index}`,
              rawJobId: normalized.jobId,
              selectedJobId: "",
              record: { ...normalized, jobId: null },
            });
            return;
          }

          addedRecords.push(normalized);
        });

        adState.records.push(...addedRecords);
        adState.unmatched.push(...newlyUnmatched);

        const summary = {
          total: rawRecords.length,
          success: addedRecords.length,
          unmatched: newlyUnmatched.length,
          errors: errorMessages,
          fileName,
          timestamp: new Date(),
        };

        adState.importLog.unshift(summary);
        if (adState.importLog.length > 25) {
          adState.importLog.length = 25;
        }

        updateFilterOptions();
        renderImportLog();
        renderUnmatchedQueue();
        renderAdvertisingPerformance();
        return summary;
      };

      const parseCsvText = (text) => {
        const sanitized = text.replace(/\r\n/g, "\n").trim();
        if (!sanitized) return [];
        const rows = [];
        let current = [];
        let field = "";
        let inQuotes = false;

        for (let i = 0; i < sanitized.length; i += 1) {
          const char = sanitized[i];
          if (char === '"') {
            if (inQuotes && sanitized[i + 1] === '"') {
              field += '"';
              i += 1;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            current.push(field);
            field = "";
          } else if (char === "\n" && !inQuotes) {
            current.push(field);
            rows.push(current);
            current = [];
            field = "";
          } else {
            field += char;
          }
        }
        current.push(field);
        rows.push(current);

        const nonEmptyRows = rows.filter((row) =>
          row.some(
            (value) => value !== null && value !== undefined && value !== ""
          )
        );
        if (!nonEmptyRows.length) return [];

        const header = nonEmptyRows[0].map((col) => col.trim());
        const dataRows = nonEmptyRows.slice(1);

        return dataRows.map((row) => {
          const record = {};
          header.forEach((col, idx) => {
            record[col] = row[idx] !== undefined ? row[idx].trim() : "";
          });
          return record;
        });
      };

      const updateFilterOptions = () => {
        const mediaValues = Array.from(
          new Set(adState.records.map((r) => r.media))
        ).sort();
        const departmentValues = Array.from(
          new Set(jobCatalog.map((job) => job.department))
        ).sort();

        const currentMedia = adState.filters.media;
        adFilterMediaSelect.innerHTML = '<option value="all">すべて</option>';
        mediaValues.forEach((media) => {
          const option = document.createElement("option");
          option.value = media;
          option.textContent = media;
          adFilterMediaSelect.appendChild(option);
        });
        if (currentMedia && currentMedia !== "all") {
          adFilterMediaSelect.value = mediaValues.includes(currentMedia)
            ? currentMedia
            : "all";
          adState.filters.media = adFilterMediaSelect.value;
        }

        const currentJob = adState.filters.job;
        adFilterJobSelect.innerHTML = '<option value="all">すべて</option>';
        jobCatalog.forEach((job) => {
          const option = document.createElement("option");
          option.value = job.id;
          option.textContent = `${job.title}（${job.department}）`;
          adFilterJobSelect.appendChild(option);
        });
        if (currentJob && currentJob !== "all") {
          adFilterJobSelect.value = jobMap[currentJob] ? currentJob : "all";
          adState.filters.job = adFilterJobSelect.value;
        }

        const currentDepartment = adState.filters.department;
        adFilterDepartmentSelect.innerHTML =
          '<option value="all">すべて</option>';
        departmentValues.forEach((dept) => {
          const option = document.createElement("option");
          option.value = dept;
          option.textContent = dept;
          adFilterDepartmentSelect.appendChild(option);
        });
        if (currentDepartment && currentDepartment !== "all") {
          adFilterDepartmentSelect.value = departmentValues.includes(
            currentDepartment
          )
            ? currentDepartment
            : "all";
          adState.filters.department = adFilterDepartmentSelect.value;
        }
      };

      const readAdFiltersFromInputs = () => {
        const fromDate = parseDateValue(adFilterFromInput.value);
        const toDateRaw = parseDateValue(adFilterToInput.value);
        adState.filters = {
          from: fromDate,
          to: toDateRaw ? normalizeEndDate(toDateRaw) : null,
          media: adFilterMediaSelect.value || "all",
          job: adFilterJobSelect.value || "all",
          department: adFilterDepartmentSelect.value || "all",
          granularity: adFilterGranularitySelect.value || "monthly",
        };

        if (adState.filters.job !== "all") {
          adState.selectedJobDetail = adState.filters.job;
          jobDetailSelect.value = adState.filters.job;
        } else if (jobDetailSelect.value !== "auto") {
          jobDetailSelect.value = "auto";
          adState.selectedJobDetail = "auto";
        }
      };

      const resetAdFilters = () => {
        adFilterFromInput.value = "";
        adFilterToInput.value = "";
        adFilterMediaSelect.value = "all";
        adFilterJobSelect.value = "all";
        adFilterDepartmentSelect.value = "all";
        adFilterGranularitySelect.value = "monthly";
        adState.filters = {
          from: null,
          to: null,
          media: "all",
          job: "all",
          department: "all",
          granularity: "monthly",
        };
        adState.selectedJobDetail = "auto";
        jobDetailSelect.value = "auto";
        renderAdvertisingPerformance();
      };

      const getFilteredAdRecords = () => {
        const { from, to, media, job, department } = adState.filters;
        return adState.records.filter((record) => {
          if (from && record.periodEnd < from) return false;
          if (to && record.periodStart > to) return false;
          if (media !== "all" && record.media !== media) return false;
          if (job !== "all" && record.jobId !== job) return false;
          if (department !== "all") {
            const info = getJobInfo(record.jobId);
            if (!info || info.department !== department) return false;
          }
          return true;
        });
      };

      const computeMediaSummary = (records) => {
        const mediaMap = new Map();
        records.forEach((record) => {
          if (!mediaMap.has(record.media)) {
            mediaMap.set(record.media, {
              media: record.media,
              baseCost: 0,
              impressions: 0,
              clicks: 0,
              applications: 0,
              introductions: 0,
              hires: 0,
            });
          }
          const bucket = mediaMap.get(record.media);
          bucket.baseCost += record.baseCost;
          bucket.impressions += record.impressions;
          bucket.clicks += record.clicks;
          bucket.applications += record.applications;
          bucket.introductions += record.introductions;
          bucket.hires += record.hires;
        });

        return Array.from(mediaMap.values()).sort(
          (a, b) => b.baseCost - a.baseCost
        );
      };

      const updateKpis = (records) => {
        const totalCostBase = records.reduce(
          (sum, record) => sum + record.baseCost,
          0
        );
        const totalApplications = records.reduce(
          (sum, record) => sum + record.applications,
          0
        );
        const totalHires = records.reduce(
          (sum, record) => sum + record.hires,
          0
        );

        kpiTotalCostEl.textContent = formatSelectedCurrency(totalCostBase);
        kpiTotalApplicationsEl.textContent = formatNumber(totalApplications);
        kpiCostApplyEl.textContent = formatCostPer(
          totalCostBase,
          totalApplications
        );
        kpiCostHireEl.textContent = formatCostPer(totalCostBase, totalHires);
        kpiTotalCostNoteEl.textContent = `データ件数: ${records.length}`;
        kpiTotalApplicationsNoteEl.textContent =
          totalApplications === 0 ? "応募実績なし" : "媒体経由応募";
      };

      const renderMediaSummary = (summary) => {
        mediaSummaryTableBody.innerHTML = "";
        if (!summary.length) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 12;
          cell.className = "text-center text-slate-500 py-6";
          cell.textContent = "データがありません。";
          row.appendChild(cell);
          mediaSummaryTableBody.appendChild(row);
          return;
        }

        summary.forEach((item) => {
          const ctr = item.impressions
            ? (item.clicks / item.impressions) * 100
            : null;
          const cvr = item.clicks
            ? (item.applications / item.clicks) * 100
            : null;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.media}</td>
            <td>${formatSelectedCurrency(item.baseCost)}</td>
            <td>${formatNumber(item.impressions)}</td>
            <td>${formatNumber(item.clicks)}</td>
            <td>${formatNumber(item.applications)}</td>
            <td>${formatNumber(item.introductions)}</td>
            <td>${formatNumber(item.hires)}</td>
            <td>${formatPercent(ctr)}</td>
            <td>${formatPercent(cvr)}</td>
            <td>${formatCostPer(item.baseCost, item.applications)}</td>
            <td>${formatCostPer(item.baseCost, item.introductions)}</td>
            <td>${formatCostPer(item.baseCost, item.hires)}</td>
          `;
          mediaSummaryTableBody.appendChild(row);
        });
      };

      const aggregateJobTimeline = (records) => {
        const granularity = adState.filters.granularity;
        const bucketMap = new Map();
        records.forEach((record) => {
          const key = getPeriodKey(record.periodStart, granularity);
          if (!bucketMap.has(key)) {
            bucketMap.set(key, {
              periodKey: key,
              periodLabel: formatPeriodLabel(record.periodStart, granularity),
              baseCost: 0,
              impressions: 0,
              clicks: 0,
              applications: 0,
              introductions: 0,
              hires: 0,
            });
          }
          const bucket = bucketMap.get(key);
          bucket.baseCost += record.baseCost;
          bucket.impressions += record.impressions;
          bucket.clicks += record.clicks;
          bucket.applications += record.applications;
          bucket.introductions += record.introductions;
          bucket.hires += record.hires;
        });

        return Array.from(bucketMap.values()).sort((a, b) =>
          a.periodKey.localeCompare(b.periodKey)
        );
      };

      const drawJobDetailChart = (timeline) => {
        jobDetailChart.innerHTML = "";
        const width = 600;
        const height = 260;
        const padding = { top: 24, right: 32, bottom: 48, left: 60 };
        const plotWidth = width - padding.left - padding.right;
        const plotHeight = height - padding.top - padding.bottom;

        if (!timeline.length) {
          const text = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text"
          );
          text.setAttribute("x", width / 2);
          text.setAttribute("y", height / 2);
          text.setAttribute("text-anchor", "middle");
          text.setAttribute("fill", "#94a3b8");
          text.textContent = "データがありません";
          jobDetailChart.appendChild(text);
          return;
        }

        const costValues = timeline.map((item) =>
          convertBaseToCurrency(item.baseCost, adState.currency)
        );
        const costMax = Math.max(...costValues, 0);
        const countMax = Math.max(
          ...timeline.map((item) =>
            Math.max(item.applications, item.introductions, item.hires)
          ),
          0
        );

        const xStep =
          timeline.length > 1 ? plotWidth / (timeline.length - 1) : 0;
        const toX = (index) => padding.left + xStep * index;
        const toY = (value, max) => {
          if (!Number.isFinite(value) || !Number.isFinite(max) || max <= 0) {
            return padding.top + plotHeight;
          }
          const ratio = value / max;
          return padding.top + plotHeight * (1 - ratio);
        };

        const svgNS = "http://www.w3.org/2000/svg";

        const axes = document.createElementNS(svgNS, "g");
        axes.setAttribute("stroke", "#cbd5f5");
        axes.setAttribute("stroke-width", "1");
        axes.innerHTML = `
          <line x1="${padding.left}" y1="${padding.top + plotHeight}" x2="${
          padding.left + plotWidth
        }" y2="${padding.top + plotHeight}" />
          <line x1="${padding.left}" y1="${padding.top}" x2="${
          padding.left
        }" y2="${padding.top + plotHeight}" />
          <line x1="${padding.left + plotWidth}" y1="${padding.top}" x2="${
          padding.left + plotWidth
        }" y2="${padding.top + plotHeight}" stroke-dasharray="4 4" />
        `;
        jobDetailChart.appendChild(axes);

        const buildPath = (values, max) => {
          if (!values.length) return "";
          return values
            .map((value, index) => {
              const x = toX(index);
              const y = toY(value, max);
              return `${index === 0 ? "M" : "L"}${x},${y}`;
            })
            .join(" ");
        };

        const costPath = document.createElementNS(svgNS, "path");
        costPath.setAttribute("d", buildPath(costValues, costMax || 1));
        costPath.setAttribute("fill", "none");
        costPath.setAttribute("stroke", "#6366f1");
        costPath.setAttribute("stroke-width", "2.5");
        jobDetailChart.appendChild(costPath);

        const applicationsPath = document.createElementNS(svgNS, "path");
        applicationsPath.setAttribute(
          "d",
          buildPath(
            timeline.map((item) => item.applications),
            countMax || 1
          )
        );
        applicationsPath.setAttribute("fill", "none");
        applicationsPath.setAttribute("stroke", "#10b981");
        applicationsPath.setAttribute("stroke-width", "2");
        jobDetailChart.appendChild(applicationsPath);

        const introductionsPath = document.createElementNS(svgNS, "path");
        introductionsPath.setAttribute(
          "d",
          buildPath(
            timeline.map((item) => item.introductions),
            countMax || 1
          )
        );
        introductionsPath.setAttribute("fill", "none");
        introductionsPath.setAttribute("stroke", "#0ea5e9");
        introductionsPath.setAttribute("stroke-width", "2");
        jobDetailChart.appendChild(introductionsPath);

        const hiresPath = document.createElementNS(svgNS, "path");
        hiresPath.setAttribute(
          "d",
          buildPath(
            timeline.map((item) => item.hires),
            countMax || 1
          )
        );
        hiresPath.setAttribute("fill", "none");
        hiresPath.setAttribute("stroke", "#f59e0b");
        hiresPath.setAttribute("stroke-width", "2");
        jobDetailChart.appendChild(hiresPath);

        timeline.forEach((item, index) => {
          const cx = toX(index);
          const costY = toY(costValues[index], costMax || 1);
          const costDot = document.createElementNS(svgNS, "circle");
          costDot.setAttribute("cx", cx);
          costDot.setAttribute("cy", costY);
          costDot.setAttribute("r", "3");
          costDot.setAttribute("fill", "#4f46e5");
          jobDetailChart.appendChild(costDot);
        });

        timeline.forEach((item, index) => {
          const x = toX(index);
          const label = document.createElementNS(svgNS, "text");
          label.setAttribute("x", x);
          label.setAttribute("y", padding.top + plotHeight + 24);
          label.setAttribute("text-anchor", "middle");
          label.setAttribute("fill", "#64748b");
          label.setAttribute("font-size", "12");
          label.textContent = item.periodLabel;
          jobDetailChart.appendChild(label);
        });

        const costAxisLabel = document.createElementNS(svgNS, "text");
        costAxisLabel.setAttribute("x", padding.left);
        costAxisLabel.setAttribute("y", padding.top - 8);
        costAxisLabel.setAttribute("text-anchor", "start");
        costAxisLabel.setAttribute("fill", "#475569");
        costAxisLabel.setAttribute("font-size", "12");
        costAxisLabel.textContent = `費用 (${adState.currency})`;
        jobDetailChart.appendChild(costAxisLabel);

        const countAxisLabel = document.createElementNS(svgNS, "text");
        countAxisLabel.setAttribute("x", width - padding.right);
        countAxisLabel.setAttribute("y", padding.top - 8);
        countAxisLabel.setAttribute("text-anchor", "end");
        countAxisLabel.setAttribute("fill", "#475569");
        countAxisLabel.setAttribute("font-size", "12");
        countAxisLabel.textContent = "件数";
        jobDetailChart.appendChild(countAxisLabel);
      };

      const renderJobDetailSummary = (records) => {
        const fields = jobDetailSummary.querySelectorAll("dd");
        if (!records.length) {
          fields.forEach((field) => {
            field.textContent = "-";
          });
          return;
        }

        const totals = records.reduce(
          (acc, record) => {
            acc.baseCost += record.baseCost;
            acc.applications += record.applications;
            acc.introductions += record.introductions;
            acc.hires += record.hires;
            acc.impressions += record.impressions;
            acc.clicks += record.clicks;
            return acc;
          },
          {
            baseCost: 0,
            applications: 0,
            introductions: 0,
            hires: 0,
            impressions: 0,
            clicks: 0,
          }
        );

        const ctr = totals.impressions
          ? (totals.clicks / totals.impressions) * 100
          : null;
        const cvr = totals.clicks
          ? (totals.applications / totals.clicks) * 100
          : null;

        jobDetailSummary.querySelector('dd[data-field="cost"]').textContent =
          formatSelectedCurrency(totals.baseCost);
        jobDetailSummary.querySelector(
          'dd[data-field="applications"]'
        ).textContent = formatNumber(totals.applications);
        jobDetailSummary.querySelector(
          'dd[data-field="introductions"]'
        ).textContent = formatNumber(totals.introductions);
        jobDetailSummary.querySelector('dd[data-field="hires"]').textContent =
          formatNumber(totals.hires);
        jobDetailSummary.querySelector('dd[data-field="ctr"]').textContent =
          formatPercent(ctr);
        jobDetailSummary.querySelector('dd[data-field="cvr"]').textContent =
          formatPercent(cvr);
        jobDetailSummary.querySelector('dd[data-field="cpa"]').textContent =
          formatCostPer(totals.baseCost, totals.applications);
        jobDetailSummary.querySelector('dd[data-field="cph"]').textContent =
          formatCostPer(totals.baseCost, totals.hires);
      };

      const renderJobDetailTable = (records) => {
        jobDetailTableBody.innerHTML = "";
        if (!records.length) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 12;
          cell.className = "text-center text-slate-500 py-6";
          cell.textContent = "該当データがありません。";
          row.appendChild(cell);
          jobDetailTableBody.appendChild(row);
          return;
        }

        const granularity = adState.filters.granularity;
        const bucketMap = new Map();
        records.forEach((record) => {
          const periodKey = getPeriodKey(record.periodStart, granularity);
          const periodLabel = formatPeriodLabel(
            record.periodStart,
            granularity
          );

          const allKey = `${periodKey}::ALL`;
          if (!bucketMap.has(allKey)) {
            bucketMap.set(allKey, {
              periodKey,
              periodLabel,
              media: "合計",
              baseCost: 0,
              impressions: 0,
              clicks: 0,
              applications: 0,
              introductions: 0,
              hires: 0,
            });
          }
          const allBucket = bucketMap.get(allKey);
          allBucket.baseCost += record.baseCost;
          allBucket.impressions += record.impressions;
          allBucket.clicks += record.clicks;
          allBucket.applications += record.applications;
          allBucket.introductions += record.introductions;
          allBucket.hires += record.hires;

          const mediaKey = `${periodKey}::${record.media}`;
          if (!bucketMap.has(mediaKey)) {
            bucketMap.set(mediaKey, {
              periodKey,
              periodLabel,
              media: record.media,
              baseCost: 0,
              impressions: 0,
              clicks: 0,
              applications: 0,
              introductions: 0,
              hires: 0,
            });
          }
          const mediaBucket = bucketMap.get(mediaKey);
          mediaBucket.baseCost += record.baseCost;
          mediaBucket.impressions += record.impressions;
          mediaBucket.clicks += record.clicks;
          mediaBucket.applications += record.applications;
          mediaBucket.introductions += record.introductions;
          mediaBucket.hires += record.hires;
        });

        const rows = Array.from(bucketMap.values()).sort((a, b) => {
          if (a.periodKey === b.periodKey) {
            if (a.media === "合計") return -1;
            if (b.media === "合計") return 1;
            return a.media.localeCompare(b.media);
          }
          return b.periodKey.localeCompare(a.periodKey);
        });

        rows.forEach((row) => {
          const highlight =
            row.hires === 0 && row.introductions > 0
              ? "入社0件"
              : row.applications === 0
              ? "応募0件"
              : "";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.periodLabel}</td>
            <td>${row.media}</td>
            <td>${formatSelectedCurrency(row.baseCost)}</td>
            <td>${formatNumber(row.impressions)}</td>
            <td>${formatNumber(row.clicks)}</td>
            <td>${formatNumber(row.applications)}</td>
            <td>${formatNumber(row.introductions)}</td>
            <td>${formatNumber(row.hires)}</td>
            <td>${formatCostPer(row.baseCost, row.applications)}</td>
            <td>${formatCostPer(row.baseCost, row.introductions)}</td>
            <td>${formatCostPer(row.baseCost, row.hires)}</td>
            <td class="${
              highlight ? "text-amber-600 font-semibold" : "text-slate-500"
            }">
              ${highlight || "—"}
            </td>
          `;
          jobDetailTableBody.appendChild(tr);
        });
      };

      const updateJobDetailSelectOptions = (jobIds) => {
        const existingValue = jobDetailSelect.value;
        jobDetailSelect.innerHTML =
          '<option value="auto">フィルター結果から自動選択</option>';
        jobIds.forEach((jobId) => {
          const option = document.createElement("option");
          option.value = jobId;
          option.textContent = getJobDisplayName(jobId);
          jobDetailSelect.appendChild(option);
        });

        if (
          existingValue &&
          existingValue !== "auto" &&
          jobIds.includes(existingValue)
        ) {
          jobDetailSelect.value = existingValue;
        } else {
          jobDetailSelect.value = "auto";
          adState.selectedJobDetail = "auto";
        }
      };

      const renderJobDetail = (records) => {
        const jobIds = Array.from(
          new Set(records.map((record) => record.jobId))
        );
        jobIds.sort();
        updateJobDetailSelectOptions(jobIds);

        let targetJobId =
          adState.selectedJobDetail === "auto"
            ? jobIds[0] || null
            : adState.selectedJobDetail;
        if (targetJobId && !jobIds.includes(targetJobId)) {
          targetJobId = jobIds[0] || null;
        }

        if (!targetJobId) {
          drawJobDetailChart([]);
          renderJobDetailSummary([]);
          renderJobDetailTable([]);
          return;
        }

        const jobRecords = records.filter(
          (record) => record.jobId === targetJobId
        );
        const timeline = aggregateJobTimeline(jobRecords);
        drawJobDetailChart(timeline);
        renderJobDetailSummary(jobRecords);
        renderJobDetailTable(jobRecords);
      };

      const renderUnmatchedQueue = () => {
        unmatchedTableBody.innerHTML = "";
        if (!adState.unmatched.length) {
          unmatchedEmptyState.classList.remove("hidden");
          unmatchedTableWrapper.classList.add("hidden");
          return;
        }

        unmatchedEmptyState.classList.add("hidden");
        unmatchedTableWrapper.classList.remove("hidden");

        adState.unmatched.forEach((entry, index) => {
          const record = entry.record;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${record.media}</td>
            <td>${entry.rawJobId}</td>
            <td>${formatDateRange(record.periodStart, record.periodEnd)}</td>
            <td>${formatSelectedCurrency(record.baseCost)}</td>
            <td>${formatNumber(record.applications)}</td>
            <td>${formatNumber(record.hires)}</td>
            <td></td>
          `;

          const selectCell = row.lastElementChild;
          const select = document.createElement("select");
          select.className =
            "bg-white border border-slate-300 rounded-md px-2 py-1 text-sm";
          select.dataset.index = index;
          select.innerHTML = '<option value="">求人を選択</option>';
          jobCatalog.forEach((job) => {
            const option = document.createElement("option");
            option.value = job.id;
            option.textContent = `${job.title}（${job.department}）`;
            select.appendChild(option);
          });
          select.value = entry.selectedJobId || "";
          select.addEventListener("change", (event) => {
            const idx = Number(event.target.dataset.index);
            if (!Number.isNaN(idx) && adState.unmatched[idx]) {
              adState.unmatched[idx].selectedJobId = event.target.value;
            }
          });
          selectCell.appendChild(select);

          unmatchedTableBody.appendChild(row);
        });
      };

      const renderImportLog = () => {
        importLogBody.innerHTML = "";
        if (!adState.importLog.length) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 4;
          cell.className = "text-center text-slate-500 py-4";
          cell.textContent = "取込履歴はまだありません。";
          row.appendChild(cell);
          importLogBody.appendChild(row);
          return;
        }

        adState.importLog.forEach((entry) => {
          const row = document.createElement("tr");
          const timestamp = `${entry.timestamp.getFullYear()}/${String(
            entry.timestamp.getMonth() + 1
          ).padStart(2, "0")}/${String(entry.timestamp.getDate()).padStart(
            2,
            "0"
          )} ${String(entry.timestamp.getHours()).padStart(2, "0")}:${String(
            entry.timestamp.getMinutes()
          ).padStart(2, "0")}`;
          const resultText =
            entry.errors && entry.errors.length
              ? `エラー ${entry.errors.length}件`
              : entry.unmatched
              ? `未突合 ${entry.unmatched}件`
              : "完了";
          const resultClass =
            entry.errors && entry.errors.length
              ? "text-rose-600 font-semibold"
              : entry.unmatched
              ? "text-amber-600 font-semibold"
              : "text-emerald-600 font-semibold";
          row.innerHTML = `
            <td>${timestamp}</td>
            <td>${entry.fileName}</td>
            <td>${entry.total}件</td>
            <td class="${resultClass}">${resultText}</td>
          `;
          importLogBody.appendChild(row);
        });
      };

      const renderAdvertisingPerformance = () => {
        const filteredRecords = getFilteredAdRecords();
        adState.latestFilteredRecords = filteredRecords;
        updateKpis(filteredRecords);
        const mediaSummary = computeMediaSummary(filteredRecords);
        adState.latestMediaSummary = mediaSummary;
        renderMediaSummary(mediaSummary);
        renderJobDetail(filteredRecords);
      };

      const loadSampleDataset = () => {
        ingestRecords(sampleAdRecords, {
          mode: "replace",
          fileName: "sample_ad_data.csv",
          sourceLabel: "sample",
        });
        resetAdFilters();
        renderAdvertisingPerformance();
      };

      const exportMediaSummary = () => {
        if (!adState.latestMediaSummary.length) {
          window.alert("媒体サマリーのデータがありません。");
          return;
        }
        const headers = [
          "media",
          "cost",
          "impressions",
          "clicks",
          "applications",
          "introductions",
          "hires",
          "ctr",
          "cvr",
          "cost_apply",
          "cost_intro",
          "cost_hire",
          `currency(${adState.currency})`,
        ];
        const rows = adState.latestMediaSummary.map((item) => {
          const cost = convertBaseToCurrency(item.baseCost, adState.currency);
          const ctr = item.impressions
            ? (item.clicks / item.impressions) * 100
            : "";
          const cvr = item.clicks
            ? (item.applications / item.clicks) * 100
            : "";
          const cpa = item.applications ? cost / item.applications : "";
          const cpi = item.introductions ? cost / item.introductions : "";
          const cph = item.hires ? cost / item.hires : "";
          return [
            `"${item.media}"`,
            cost !== "" ? cost.toFixed(2) : "",
            item.impressions,
            item.clicks,
            item.applications,
            item.introductions,
            item.hires,
            ctr !== "" ? ctr.toFixed(2) : "",
            cvr !== "" ? cvr.toFixed(2) : "",
            cpa !== "" ? cpa.toFixed(2) : "",
            cpi !== "" ? cpi.toFixed(2) : "",
            cph !== "" ? cph.toFixed(2) : "",
            adState.currency,
          ];
        });
        const csv = [
          headers.join(","),
          ...rows.map((row) => row.join(",")),
        ].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `media_summary_${Date.now()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const downloadCsvTemplate = () => {
        const headers = [
          "media",
          "job_id",
          "period_start",
          "period_end",
          "impressions",
          "clicks",
          "applications",
          "introductions",
          "hires",
          "cost",
          "currency",
        ];
        const sampleRow = [
          "Indeed",
          "JOB-001",
          "2024-05-01",
          "2024-05-31",
          "10000",
          "320",
          "40",
          "18",
          "3",
          "75000",
          "JPY",
        ];
        const csv = [headers.join(","), sampleRow.join(",")].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "ad_performance_template.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const handleCsvUpload = (file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const parsed = parseCsvText(event.target.result);
            ingestRecords(parsed, { fileName: file.name });
          } catch (error) {
            window.alert(`CSVの読み込みに失敗しました: ${error.message}`);
          }
        };
        reader.readAsText(file);
      };

      if (currencySelect) {
        currencySelect.addEventListener("change", (event) => {
          adState.currency = event.target.value;
          renderAdvertisingPerformance();
          renderUnmatchedQueue();
        });
      }

      if (adFilterApplyBtn) {
        adFilterApplyBtn.addEventListener("click", () => {
          readAdFiltersFromInputs();
          renderAdvertisingPerformance();
        });
      }

      if (adFilterResetBtn) {
        adFilterResetBtn.addEventListener("click", () => {
          resetAdFilters();
        });
      }

      if (jobDetailSelect) {
        jobDetailSelect.addEventListener("change", (event) => {
          adState.selectedJobDetail = event.target.value || "auto";
          renderJobDetail(adState.latestFilteredRecords);
        });
      }

      if (exportMediaSummaryBtn) {
        exportMediaSummaryBtn.addEventListener("click", () => {
          exportMediaSummary();
        });
      }

      if (downloadCsvTemplateBtn) {
        downloadCsvTemplateBtn.addEventListener("click", () => {
          downloadCsvTemplate();
        });
      }

      if (loadSampleDataBtn) {
        loadSampleDataBtn.addEventListener("click", () => {
          loadSampleDataset();
        });
      }

      if (adCsvInput) {
        adCsvInput.addEventListener("change", (event) => {
          const [file] = event.target.files || [];
          if (file) {
            handleCsvUpload(file);
          }
          event.target.value = "";
        });
      }

      if (resolveUnmatchedBtn) {
        resolveUnmatchedBtn.addEventListener("click", () => {
          const resolvedEntries = [];
          adState.unmatched = adState.unmatched.filter((entry) => {
            if (entry.selectedJobId) {
              const jobInfo = getJobInfo(entry.selectedJobId);
              if (!jobInfo) return true;
              const resolvedRecord = {
                ...entry.record,
                jobId: entry.selectedJobId,
              };
              adState.records.push(resolvedRecord);
              resolvedEntries.push(entry);
              return false;
            }
            return true;
          });
          if (!resolvedEntries.length) {
            window.alert("マッピングを選択してください。");
          } else {
            renderUnmatchedQueue();
            renderAdvertisingPerformance();
          }
        });
      }

      if (clearUnmatchedSelectionsBtn) {
        clearUnmatchedSelectionsBtn.addEventListener("click", () => {
          adState.unmatched.forEach((entry) => {
            entry.selectedJobId = "";
          });
          renderUnmatchedQueue();
        });
      }

      updateFilterOptions();
      renderImportLog();
      renderUnmatchedQueue();
      renderAdvertisingPerformance();

      const candidateTableBody = document.getElementById("candidateTableBody");
      const candidateRows = Array.from(
        document.querySelectorAll(".candidate-row")
      );
      const filterCandidateName = document.getElementById(
        "filterCandidateName"
      );
      const filterCompany = document.getElementById("filterCompany");
      const filterOwner = document.getElementById("filterOwner");
      const filterInitialFrom = document.getElementById("filterInitialFrom");
      const filterInitialTo = document.getElementById("filterInitialTo");
      const phaseCheckboxes = Array.from(
        document.querySelectorAll(".phase-filter")
      );
      const sortKeySelect = document.getElementById("sortKey");
      const sortDirectionBtn = document.getElementById("sortDirection");
      const filterApplyBtn = document.getElementById("filterApply");
      const filterResetBtn = document.getElementById("filterReset");

      const phaseOrder = [
        "新規面談",
        "紹介可能",
        "企業に紹介",
        "面接前",
        "面接後",
        "内定獲得",
        "内定承諾待ち",
        "内定承諾",
      ];
      const phaseIndexMap = phaseOrder.reduce((acc, phase, index) => {
        acc[phase] = index;
        return acc;
      }, {});

      const parseDateValue = (value) => {
        if (!value) return null;
        const parsed = new Date(value);
        return Number.isNaN(parsed.getTime()) ? null : parsed;
      };

      const getRowInitialDate = (row) =>
        parseDateValue(row.dataset.initialDatetime || row.dataset.initial);

      const getSortValue = (row, key) => {
        if (key === "initial") {
          const date = getRowInitialDate(row);
          return date ? date.getTime() : null;
        }
        if (key === "stuck") {
          return Number(row.dataset.stuckDays || 0);
        }
        // default: phase
        const phase = row.dataset.phase || "";
        return phaseIndexMap.hasOwnProperty(phase) ? phaseIndexMap[phase] : -1;
      };

      const applyCandidateSort = () => {
        if (!candidateTableBody) return;
        const sortKey = sortKeySelect ? sortKeySelect.value : "phase";
        const order = sortDirectionBtn
          ? sortDirectionBtn.dataset.order || "desc"
          : "desc";
        const multiplier = order === "asc" ? 1 : -1;

        const rowsCopy = candidateRows.slice();
        rowsCopy.sort((a, b) => {
          const valueA = getSortValue(a, sortKey);
          const valueB = getSortValue(b, sortKey);

          const bothNull = valueA === null && valueB === null;
          if (!bothNull) {
            if (valueA === null || Number.isNaN(valueA)) return 1;
            if (valueB === null || Number.isNaN(valueB)) return -1;
            if (valueA !== valueB) {
              return valueA > valueB ? 1 * multiplier : -1 * multiplier;
            }
          }

          const nameA = (a.dataset.name || "").toLowerCase();
          const nameB = (b.dataset.name || "").toLowerCase();
          return nameA.localeCompare(nameB, "ja") * multiplier;
        });

        rowsCopy.forEach((row) => candidateTableBody.appendChild(row));
      };

      const applyCandidateFilters = () => {
        const nameQuery = filterCandidateName
          ? filterCandidateName.value.trim().toLowerCase()
          : "";
        const company = filterCompany ? filterCompany.value : "すべて";
        const owner = filterOwner ? filterOwner.value : "すべて";
        const fromDate = parseDateValue(
          filterInitialFrom ? filterInitialFrom.value : ""
        );
        const toDateRaw = parseDateValue(
          filterInitialTo ? filterInitialTo.value : ""
        );
        const toDate = toDateRaw
          ? new Date(
              toDateRaw.getFullYear(),
              toDateRaw.getMonth(),
              toDateRaw.getDate(),
              23,
              59,
              59,
              999
            )
          : null;
        const activePhases = new Set(
          phaseCheckboxes
            .filter((checkbox) => checkbox.checked)
            .map((checkbox) => checkbox.value)
        );

        candidateRows.forEach((row) => {
          let visible = true;

          if (visible && nameQuery) {
            const name = (row.dataset.name || "").toLowerCase();
            visible = name.includes(nameQuery);
          }

          if (visible && company && company !== "すべて") {
            visible = row.dataset.company === company;
          }

          if (visible && owner && owner !== "すべて") {
            visible = row.dataset.owner === owner;
          }

          if (visible && (fromDate || toDate)) {
            const rowDate = getRowInitialDate(row);
            if (!rowDate) {
              visible = false;
            } else {
              if (fromDate && rowDate < fromDate) {
                visible = false;
              }
              if (toDate && rowDate > toDate) {
                visible = false;
              }
            }
          }

          if (visible && activePhases.size > 0) {
            visible = activePhases.has(row.dataset.phase);
          }

          row.style.display = visible ? "" : "none";
          row.dataset.visible = visible ? "true" : "false";
        });

        applyCandidateSort();
      };

      const resetCandidateFilters = () => {
        if (filterCandidateName) filterCandidateName.value = "";
        if (filterCompany) filterCompany.value = "すべて";
        if (filterOwner) filterOwner.value = "すべて";
        if (filterInitialFrom) filterInitialFrom.value = "";
        if (filterInitialTo) filterInitialTo.value = "";
        phaseCheckboxes.forEach((checkbox) => {
          checkbox.checked = true;
        });
        if (sortKeySelect) sortKeySelect.value = "phase";
        if (sortDirectionBtn) {
          sortDirectionBtn.dataset.order = "desc";
          sortDirectionBtn.textContent = "降順";
        }
        applyCandidateFilters();
      };

      if (filterApplyBtn) {
        filterApplyBtn.addEventListener("click", () => {
          applyCandidateFilters();
        });
      }

      if (filterResetBtn) {
        filterResetBtn.addEventListener("click", () => {
          resetCandidateFilters();
        });
      }

      if (filterCandidateName) {
        filterCandidateName.addEventListener("input", () => {
          applyCandidateFilters();
        });
      }
      if (filterCompany) {
        filterCompany.addEventListener("change", () => {
          applyCandidateFilters();
        });
      }
      if (filterOwner) {
        filterOwner.addEventListener("change", () => {
          applyCandidateFilters();
        });
      }
      if (filterInitialFrom) {
        filterInitialFrom.addEventListener("change", () => {
          applyCandidateFilters();
        });
      }
      if (filterInitialTo) {
        filterInitialTo.addEventListener("change", () => {
          applyCandidateFilters();
        });
      }
      phaseCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          applyCandidateFilters();
        });
      });

      if (sortKeySelect) {
        sortKeySelect.addEventListener("change", () => {
          applyCandidateSort();
        });
      }

      if (sortDirectionBtn) {
        sortDirectionBtn.addEventListener("click", () => {
          const current =
            sortDirectionBtn.dataset.order === "asc" ? "asc" : "desc";
          const next = current === "asc" ? "desc" : "asc";
          sortDirectionBtn.dataset.order = next;
          sortDirectionBtn.textContent = next === "asc" ? "昇順" : "降順";
          applyCandidateSort();
        });
      }

      const roleSelect = document.getElementById("roleSelect");
      const drawer = document.getElementById("candidateDrawer");
      const overlay = document.getElementById("drawerOverlay");
      const drawerName = document.getElementById("drawerName");
      const drawerCompany = document.getElementById("drawerCompany");
      const drawerOwner = document.getElementById("drawerOwner");
      const drawerPhase = document.getElementById("drawerPhase");
      const drawerInitial = document.getElementById("drawerInitial");
      const drawerStuck = document.getElementById("drawerStuck");
      const drawerAddress = document.getElementById("drawerAddress");
      const drawerPhone = document.getElementById("drawerPhone");
      const drawerEmail = document.getElementById("drawerEmail");
      const drawerTimeline = document.getElementById("drawerTimeline");
      const drawerNextAction = document.getElementById("drawerNextAction");
      const drawerMemo = document.getElementById("drawerMemo");
      const drawerClose = document.getElementById("drawerClose");

      let currentCandidateRow = null;

      const updateContactMask = () => {
        if (!roleSelect) return;
        const isManager = roleSelect.value === "manager";
        document.querySelectorAll(".contact-field").forEach((field) => {
          field.textContent = isManager
            ? field.dataset.full
            : field.dataset.masked;
        });
        if (currentCandidateRow) {
          drawerPhone.textContent = isManager
            ? currentCandidateRow.dataset.phoneFull
            : currentCandidateRow.dataset.phoneMasked;
          drawerEmail.textContent = isManager
            ? currentCandidateRow.dataset.emailFull
            : currentCandidateRow.dataset.emailMasked;
        }
      };

      if (roleSelect) {
        roleSelect.addEventListener("change", updateContactMask);
      }

      const closeDrawer = () => {
        drawer.classList.remove("open");
        overlay.classList.remove("visible");
        currentCandidateRow = null;
      };

      const populateDrawer = (row) => {
        currentCandidateRow = row;
        const isManager = roleSelect && roleSelect.value === "manager";
        drawerName.textContent = row.dataset.name || "-";
        drawerCompany.textContent = row.dataset.company || "-";
        drawerOwner.textContent = row.dataset.owner || "-";
        drawerPhase.textContent = row.dataset.phase || "-";
        drawerInitial.textContent = row.dataset.initial
          ? `初回接点 ${row.dataset.initial}`
          : "初回接点 -";

        const stuckDays = Number(row.dataset.stuckDays || 0);
        drawerStuck.textContent = `滞留${stuckDays}日`;
        drawerStuck.classList.remove(
          "bg-rose-100",
          "text-rose-600",
          "bg-emerald-50",
          "text-emerald-700"
        );
        if (stuckDays >= 5) {
          drawerStuck.classList.add("bg-rose-100", "text-rose-600");
        } else if (stuckDays === 0) {
          drawerStuck.classList.add("bg-emerald-50", "text-emerald-700");
        }

        drawerAddress.textContent = row.dataset.address || "-";
        drawerPhone.textContent = isManager
          ? row.dataset.phoneFull || "-"
          : row.dataset.phoneMasked || "-";
        drawerEmail.textContent = isManager
          ? row.dataset.emailFull || "-"
          : row.dataset.emailMasked || "-";
        drawerNextAction.textContent = row.dataset.nextAction || "-";
        drawerMemo.textContent = row.dataset.memo || "-";

        drawerTimeline.innerHTML = "";
        const timelineRaw = row.dataset.timeline || "";
        timelineRaw.split(";").forEach((entry) => {
          if (!entry) return;
          const [phase, date] = entry.split("|");
          const item = document.createElement("div");
          item.className = "timeline-item";
          item.innerHTML = `
            <p class="text-sm font-semibold text-slate-700">${phase || "-"}</p>
            <p class="text-xs text-slate-500">${date || "ー"}</p>
          `;
          drawerTimeline.appendChild(item);
        });
      };

      candidateRows.forEach((row) => {
        row.addEventListener("click", () => {
          populateDrawer(row);
          drawer.classList.add("open");
          overlay.classList.add("visible");
        });
      });

      if (drawerClose) {
        drawerClose.addEventListener("click", closeDrawer);
      }
      if (overlay) {
        overlay.addEventListener("click", closeDrawer);
      }
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeDrawer();
        }
      });

      applyCandidateFilters();
      updateContactMask();
    </script>
  </body>
</html>